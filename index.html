<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card√°pio Digital</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { box-sizing: border-box; }
    * { scrollbar-width: thin; scrollbar-color: #d97706 #1a1a1a; }
    .menu-item { transition: all 0.25s ease; cursor: pointer; }
    .menu-item:hover { transform: translateY(-2px); border-color: rgba(217,119,6,.55) !important; }
    .badge { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.85} }
    .whatsapp-btn { animation: bounce 2s infinite; }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

    .delivery-animation { position: relative; height: 50px; }
    .delivery-bike { animation: bikeMove 3s ease-in-out infinite; }
    .delivery-person { animation: personBounce 0.5s ease-in-out infinite; }
    .delivery-box { animation: boxShake 0.6s ease-in-out infinite; }
    .delivery-sparkle { animation: sparkle 1.5s ease-in-out infinite; }

    @keyframes bikeMove {
      0%,100%{transform:translateX(0) rotate(0deg)}
      25%{transform:translateX(10px) rotate(2deg)}
      50%{transform:translateX(0) rotate(0deg)}
      75%{transform:translateX(-10px) rotate(-2deg)}
    }
    @keyframes personBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
    @keyframes boxShake {
      0%,100%{transform:rotate(0deg) scale(1)}
      25%{transform:rotate(-5deg) scale(1.05)}
      75%{transform:rotate(5deg) scale(1.05)}
    }
    @keyframes sparkle { 0%,100%{opacity:0;transform:scale(.8)} 50%{opacity:1;transform:scale(1.2)} }

    .category-icon { transition: transform 0.3s ease; }
    .category-header:hover .category-icon { transform: scale(1.1); }

    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 16px;
    }
    .modal-overlay.active{ display: flex; }

    .modal-content{
      width: 100%;
      max-width: 900px;
      border-radius: 18px;
      background: linear-gradient(135deg, #262626 0%, #1f1f1f 100%);
      border: 1px solid #404040;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }

    .game-frame{
      width: 100%;
      height: 70vh;
      max-height: 520px;
      border: 0;
      border-radius: 14px;
      background: #000;
    }

    .cart-fab{
      position: fixed;
      right: 16px;
      bottom: 100px;
      z-index: 2500;
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      color: #1a1a1a;
      font-weight: 800;
      box-shadow: 0 14px 30px rgba(217,119,6,.25);
      cursor: pointer;
      user-select: none;
    }
    .cart-badge{
      min-width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      background: rgba(26,26,26,.92);
      color: #fef3c7;
      font-weight: 800;
      padding: 0 8px;
    }
  </style>
</head>

<body class="h-full">
  <div id="app-wrapper" class="h-full w-full overflow-auto"
       style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);">

    <!-- Header -->
    <header class="relative overflow-hidden"
            style="background: linear-gradient(135deg, #b91c1c 0%, #991b1b 50%, #7f1d1d 100%);">
      <div class="absolute inset-0 opacity-10">
        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
          <pattern id="pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
            <circle cx="10" cy="10" r="1" fill="#d97706" />
          </pattern>
          <rect width="100%" height="100%" fill="url(#pattern)" />
        </svg>
      </div>

      <div class="relative px-6 py-8 text-center">
        <div class="mb-4 flex justify-center">
          <div class="w-20 h-20 rounded-full overflow-hidden flex items-center justify-center"
               style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); box-shadow: 0 4px 20px rgba(217, 119, 6, 0.4); border:1px solid rgba(0,0,0,.25);">
            <img id="restaurant-logo" alt="Logo" class="w-full h-full object-cover hidden">
            <div id="restaurant-logo-fallback" class="w-full h-full flex items-center justify-center">
              <svg class="w-10 h-10" fill="#1a1a1a" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
              </svg>
            </div>
          </div>
        </div>

        <h1 id="restaurant-name" class="text-3xl md:text-4xl font-bold mb-2"
            style="font-family:'Playfair Display',serif;color:#fef3c7;">Carregando‚Ä¶</h1>

        <p id="restaurant-slogan" class="text-lg opacity-90"
           style="font-family:'Poppins',sans-serif;color:#fde68a;">Sabor que conquista no primeiro pedido</p>

        <div class="mt-6 inline-block px-6 py-3 rounded-full"
             style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);">
          <p class="text-sm font-semibold" style="font-family:'Poppins',sans-serif;color:#1a1a1a;">
            üïí <span id="restaurant-hours">Seg a Dom: 11h √†s 23h</span>
          </p>
        </div>
      </div>
    </header>

    <main class="px-4 py-6 max-w-2xl mx-auto" style="font-family:'Poppins',sans-serif;">

      <div id="no-restaurant" class="hidden mb-6 p-4 rounded-xl border border-red-500/30 bg-red-500/10">
        <p class="font-bold" style="color:#fecaca;">‚ö†Ô∏è Restaurante n√£o encontrado</p>
        <p class="text-sm mt-1" style="color:#fecaca;">
          Abra com <b>?r=ID_DO_RESTAURANTE</b> (ex: <i>index.html?r=rest_xxxx</i>)
        </p>
      </div>

      <!-- GAME CTA -->
      <div class="mb-6">
        <button onclick="openGame()"
          class="w-full py-4 rounded-2xl font-extrabold text-lg shadow-lg"
          style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:#1a1a1a;">
          üéÆ Jogar (enquanto espera)
        </button>
        <p class="text-xs text-center mt-2" style="color:#9ca3af;">
          Obs.: Subway Surfers geralmente bloqueia abrir dentro do site. Se bloquear, aparece bot√£o pra abrir em nova aba.
        </p>
      </div>

      <!-- CARD√ÅPIO -->
      <section class="mb-8">
        <div class="category-header flex items-center gap-3 mb-4 pb-2" style="border-bottom:2px solid #d97706;">
          <span class="category-icon text-3xl"></span>
          <h2 id="title-Lanches" class="text-2xl font-bold" style="color:#d97706;font-family:'Playfair Display',serif;">Lanches</h2>
        </div>
        <div id="products-Lanches" class="space-y-3"></div>
      </section>

      <section class="mb-8">
        <div class="category-header flex items-center gap-3 mb-4 pb-2" style="border-bottom:2px solid #d97706;">
          <span class="category-icon text-3xl"></span>
          <h2 id="title-Pizzas" class="text-2xl font-bold" style="color:#d97706;font-family:'Playfair Display',serif;">Pizzas</h2>
        </div>
        <div id="products-Pizzas" class="space-y-3"></div>
      </section>

      <section class="mb-8">
        <div class="category-header flex items-center gap-3 mb-4 pb-2" style="border-bottom:2px solid #d97706;">
          <span class="category-icon text-3xl"></span>
          <h2 id="title-Bebidas" class="text-2xl font-bold" style="color:#d97706;font-family:'Playfair Display',serif;">Bebidas</h2>
        </div>
        <div id="products-Bebidas" class="grid grid-cols-2 gap-3"></div>
      </section>

      <section class="mb-8">
        <div class="category-header flex items-center gap-3 mb-4 pb-2" style="border-bottom:2px solid #d97706;">
          <span class="category-icon text-3xl"></span>
          <h2 id="title-Sobremesas" class="text-2xl font-bold" style="color:#d97706;font-family:'Playfair Display',serif;">Sobremesas</h2>
        </div>
        <div id="products-Sobremesas" class="space-y-3"></div>
      </section>

      <!-- CTA -->
      <div class="sticky bottom-4 z-50 px-4">
        <div class="delivery-animation mb-3 flex items-center justify-center gap-2">
          <span class="delivery-bike text-4xl">üèçÔ∏è</span>
          <span class="delivery-person text-3xl">üßë‚Äçüç≥</span>
          <span class="delivery-box text-3xl">üì¶</span>
          <span class="delivery-sparkle text-2xl">‚ú®</span>
        </div>

        <button onclick="openCart()"
          class="whatsapp-btn block w-full py-4 rounded-full text-center font-bold text-lg shadow-lg"
          style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; font-family: 'Poppins', sans-serif; box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);">
          üõí Ver Carrinho e Finalizar Pedido
        </button>
      </div>

      <footer class="mt-8 pb-24 text-center">
        <div class="py-6 rounded-xl mx-4"
             style="background: linear-gradient(135deg, #262626 0%, #1f1f1f 100%); border: 1px solid #404040;">
          <p class="text-sm opacity-80" style="color: #d6d3d1;">üìç Delivery e Retirada</p>
          <p id="footer-hours" class="text-sm mt-1 opacity-60" style="color: #d6d3d1;">‚Äî</p>
          <div class="flex justify-center gap-4 mt-4">
            <span class="text-2xl">üí≥</span><span class="text-2xl">üíµ</span><span class="text-2xl">üì±</span>
          </div>
          <p class="text-xs mt-3 opacity-40" style="color: #d6d3d1;">Aceitamos Cart√£o, Dinheiro e Pix</p>
          <p class="text-xs mt-3 opacity-60" style="color:#d6d3d1;">Desenvolvido por MarksmktDigital</p>
        </div>
      </footer>
    </main>

    <!-- Floating cart -->
    <div id="cart-btn" class="cart-fab" onclick="openCart()">
      üõí Carrinho <span id="cart-count" class="cart-badge">0</span>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay">
      <div class="modal-content p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold" style="color:#d97706; font-family:'Playfair Display',serif;">Seu Carrinho üõí</h2>
          <button onclick="closeCart()" class="text-3xl" style="color:#d6d3d1;">√ó</button>
        </div>

        <div id="cart-items" class="space-y-3 mb-6"></div>

        <div class="border-t pt-4 mb-6" style="border-color:#404040;">
          <div class="flex justify-between items-center mb-2">
            <span class="text-lg" style="color:#d6d3d1;">Subtotal:</span>
            <span id="cart-total" class="text-2xl font-bold" style="color:#d97706;">R$ 0,00</span>
          </div>
        </div>

        <button onclick="openCheckout()" class="w-full py-4 rounded-xl font-bold text-lg"
                style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: #1a1a1a;">
          Finalizar Pedido üéØ
        </button>
      </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal-overlay">
      <div class="modal-content p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold" style="color:#d97706; font-family:'Playfair Display',serif;">Dados de Entrega üìç</h2>
          <button onclick="closeCheckout()" class="text-3xl" style="color:#d6d3d1;">√ó</button>
        </div>

        <form id="checkout-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">Nome Completo</label>
            <input type="text" id="customer-name" required class="w-full px-4 py-3 rounded-lg"
                   style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="Seu nome">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">Telefone (WhatsApp)</label>
            <input type="tel" id="customer-phone" required class="w-full px-4 py-3 rounded-lg"
                   style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="(11) 99999-9999">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">CEP</label>
            <input type="text" id="customer-cep" required maxlength="9" class="w-full px-4 py-3 rounded-lg"
                   style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="00000-000">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">Endere√ßo</label>
            <input type="text" id="customer-address" required class="w-full px-4 py-3 rounded-lg"
                   style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="Rua, n√∫mero">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">Bairro</label>
              <input type="text" id="customer-neighborhood" required class="w-full px-4 py-3 rounded-lg"
                     style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="Bairro">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">Cidade</label>
              <input type="text" id="customer-city" required class="w-full px-4 py-3 rounded-lg"
                     style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="Cidade">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2" style="color:#fef3c7;">Complemento (Opcional)</label>
            <input type="text" id="customer-complement" class="w-full px-4 py-3 rounded-lg"
                   style="background:#1a1a1a; border:1px solid #404040; color:#fef3c7;" placeholder="Apto, bloco...">
          </div>

          <button type="submit" class="w-full py-4 rounded-xl font-bold text-lg"
                  style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">
            Enviar Pedido üì≤
          </button>

          <p id="checkout-error" class="text-sm hidden" style="color:#ef4444;">
            N√£o foi poss√≠vel salvar seu pedido. Tente novamente.
          </p>
        </form>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal-overlay">
      <div class="modal-content p-8 text-center">
        <div class="text-8xl mb-4">‚úÖ</div>
        <h2 class="text-3xl font-bold mb-3" style="color:#22c55e; font-family:'Playfair Display',serif;">Pedido Salvo!</h2>
        <p class="text-lg mb-6" style="color:#d6d3d1;">Agora vamos abrir o WhatsApp para voc√™ enviar a mensagem. üéâ</p>

        <div class="mb-6 p-4 rounded-xl" style="background:#1a1a1a; border:1px solid #404040;">
          <p class="text-sm mb-2" style="color:#fef3c7;">Tempo estimado de entrega:</p>
          <p class="text-2xl font-bold" style="color:#d97706;">30-45 minutos ‚è±Ô∏è</p>
        </div>

        <button onclick="closeSuccess()" class="text-sm" style="color:#d6d3d1;">Voltar ao card√°pio</button>
      </div>
    </div>

    <!-- GAME MODAL -->
    <div id="game-modal" class="modal-overlay">
      <div class="modal-content p-4">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-xl font-bold" style="color:#fef3c7; font-family:'Playfair Display',serif;">üéÆ Jogo</h2>
          <button onclick="closeGame()" class="text-3xl" style="color:#d6d3d1;">√ó</button>
        </div>

        <div class="rounded-2xl overflow-hidden" style="border:1px solid #404040;">
          <iframe
            id="game-iframe"
            class="game-frame"
            src=""
            loading="lazy"
            referrerpolicy="no-referrer"
            allow="fullscreen; autoplay"
            sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-popups"
          ></iframe>
        </div>

        <div id="game-fallback" class="mt-4 hidden text-center">
          <p class="text-sm mb-3" style="color:#d6d3d1;">
            O Subway Surfers bloqueia abrir dentro do site. Clique abaixo para jogar em nova aba:
          </p>
          <a id="game-open-tab" class="inline-block px-5 py-3 rounded-xl font-extrabold"
             style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color:#06140b;"
             target="_blank" rel="noopener">
            Abrir em nova aba ‚úÖ
          </a>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqFZJ5wg3VIJlJtA4DgFS499_9rXu-zAk",
      authDomain: "cardapio-digital-adc3d.firebaseapp.com",
      projectId: "cardapio-digital-adc3d",
      storageBucket: "cardapio-digital-adc3d.firebasestorage.app",
      messagingSenderId: "762370492160",
      appId: "1:762370492160:web:86a86687c52a76f56895e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const digits = (v) => String(v||"").replace(/\D/g,"");

    // ==============================
    // Multi-restaurante
    // ==============================
    function getRestaurantId(){
      const url = new URL(location.href);
      return (url.searchParams.get("r") || "").trim();
    }
    const restaurantId = getRestaurantId();

    const restRef = restaurantId ? doc(db, "restaurants", restaurantId) : null;
    const menuRef = restaurantId ? doc(db, "restaurants", restaurantId, "settings", "menu") : null;
    const productsRef = restaurantId ? collection(db, "restaurants", restaurantId, "products") : null;
    const ordersRef = restaurantId ? collection(db, "restaurants", restaurantId, "orders") : null;

    let restaurant = {
      name: "Card√°pio Digital",
      logoUrl: "",
      daysText: "Seg a Dom",
      hoursText: "11h √†s 23h",
      whatsappPhone: ""
    };

    function setHeader(){
      $("restaurant-name").textContent = restaurant.name || "Card√°pio Digital";
      $("restaurant-hours").textContent = `${restaurant.daysText || ""}: ${restaurant.hoursText || ""}`.replace(" : ", ": ");
      $("footer-hours").textContent = `${restaurant.daysText || ""}: ${restaurant.hoursText || ""}`.replace(" : ", ": ");

      const img = $("restaurant-logo");
      const fallback = $("restaurant-logo-fallback");

      if(restaurant.logoUrl){
        img.src = restaurant.logoUrl;
        img.onload = () => { img.classList.remove("hidden"); fallback.classList.add("hidden"); };
        img.onerror = () => { img.classList.add("hidden"); fallback.classList.remove("hidden"); };
      } else {
        img.classList.add("hidden");
        fallback.classList.remove("hidden");
      }
    }

    async function loadRestaurant(){
      if(!restaurantId){
        $("no-restaurant").classList.remove("hidden");
        $("restaurant-name").textContent = "Card√°pio";
        return false;
      }
      try{
        const snap = await getDoc(restRef);
        if(!snap.exists()){
          $("no-restaurant").classList.remove("hidden");
          $("restaurant-name").textContent = "Restaurante n√£o encontrado";
          return false;
        }
        restaurant = { ...restaurant, ...snap.data() };
        setHeader();
        return true;
      }catch(e){
        console.error("Erro ao carregar restaurante:", e);
        $("no-restaurant").classList.remove("hidden");
        return false;
      }
    }

    // ==============================
    // Toast
    // ==============================
    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed; top: 80px; right: 20px;
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        color: #1a1a1a; padding: 12px 18px; border-radius: 999px;
        font-weight: 800; z-index: 5000; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2200);
    }

    // ==============================
    // Carrinho
    // ==============================
    let cart = [];
    function moneyBR(v){
      const n = Number(v || 0);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function updateCartUI() {
      const cartBtn = $("cart-btn");
      const cartCount = $("cart-count");
      const cartItems = $("cart-items");
      const cartTotal = $("cart-total");

      const totalItems = cart.reduce((s, i) => s + i.quantity, 0);
      const totalPrice = cart.reduce((s, i) => s + i.price * i.quantity, 0);

      if (totalItems > 0) {
        cartBtn.style.display = 'inline-flex';
        cartCount.textContent = totalItems;
      } else {
        cartBtn.style.display = 'none';
      }

      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-center py-8" style="color:#d6d3d1;">Seu carrinho est√° vazio</p>';
      } else {
        cartItems.innerHTML = cart.map((item, idx) => `
          <div class="flex items-center gap-3 p-3 rounded-lg" style="background:#1a1a1a; border:1px solid #404040;">
            <span class="text-2xl">${item.emoji}</span>
            <div class="flex-1">
              <h4 class="font-semibold" style="color:#fef3c7;">${item.name}</h4>
              <p class="text-sm" style="color:#d97706;">${moneyBR(item.price)}</p>
            </div>
            <div class="flex items-center gap-2">
              <button data-dec="${idx}" class="w-8 h-8 rounded-full font-bold" style="background:#404040; color:#fef3c7;">-</button>
              <span class="w-8 text-center font-bold" style="color:#fef3c7;">${item.quantity}</span>
              <button data-inc="${idx}" class="w-8 h-8 rounded-full font-bold" style="background:#d97706; color:#1a1a1a;">+</button>
            </div>
            <button data-del="${idx}" class="text-xl" style="color:#ef4444;">üóëÔ∏è</button>
          </div>
        `).join('');

        cartItems.querySelectorAll("button[data-dec]").forEach(b=>{
          b.onclick = () => { const i=Number(b.dataset.dec); cart[i].quantity--; if(cart[i].quantity<=0) cart.splice(i,1); updateCartUI(); };
        });
        cartItems.querySelectorAll("button[data-inc]").forEach(b=>{
          b.onclick = () => { const i=Number(b.dataset.inc); cart[i].quantity++; updateCartUI(); };
        });
        cartItems.querySelectorAll("button[data-del]").forEach(b=>{
          b.onclick = () => { const i=Number(b.dataset.del); cart.splice(i,1); updateCartUI(); };
        });
      }

      cartTotal.textContent = moneyBR(totalPrice);
    }

    window.addToCart = function(name, price, emoji){
      const existing = cart.find(i => i.name === name);
      if (existing) existing.quantity++;
      else cart.push({ name, price, emoji, quantity: 1 });
      updateCartUI();
      showToast(`${emoji} ${name} adicionado!`);
    };

    window.openCart = function(){
      if (cart.length === 0) { showToast('‚ö†Ô∏è Adicione itens primeiro!'); return; }
      $("cart-modal").classList.add("active");
    };
    window.closeCart = function(){ $("cart-modal").classList.remove("active"); };

    window.openCheckout = function(){
      if (cart.length === 0) return;
      window.closeCart();
      $("checkout-modal").classList.add("active");
    };
    window.closeCheckout = function(){ $("checkout-modal").classList.remove("active"); };

    window.closeSuccess = function(){
      $("success-modal").classList.remove("active");
      cart = [];
      updateCartUI();
    };

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
      });
    });

    $("customer-cep").addEventListener('input', function(e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length > 5) v = v.slice(0,5) + '-' + v.slice(5,8);
      e.target.value = v;
    });

    // ==============================
    // Checkout -> salva order + abre WhatsApp
    // ==============================
    $("checkout-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("checkout-error").classList.add("hidden");

      try {
        if (!restaurantId || !ordersRef) { showToast("Restaurante inv√°lido."); return; }
        if (!cart.length) { showToast("Carrinho vazio."); return; }

        const name = $("customer-name").value.trim();
        const phone = $("customer-phone").value.trim();
        const cep = $("customer-cep").value.trim();
        const address = $("customer-address").value.trim();
        const neighborhood = $("customer-neighborhood").value.trim();
        const city = $("customer-city").value.trim();
        const complement = $("customer-complement").value.trim();

        const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
        const addressLine = `${address} ‚Äî ${neighborhood}, ${city} ‚Ä¢ CEP ${cep}${complement ? " ‚Ä¢ " + complement : ""}`;

        const orderDoc = {
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          status: "new",
          customer: { name, phone, addressLine },
          items: cart.map(i => ({ name: i.name, qty: i.quantity, price: i.price, emoji: i.emoji })),
          total: Number(total)
        };

        await addDoc(ordersRef, orderDoc);

        let msg = `üçΩÔ∏è *NOVO PEDIDO*\\n\\n`;
        msg += `üè™ *Restaurante:* ${restaurant.name || ""}\\n\\n`;
        msg += `üë§ *Cliente:* ${name}\\n`;
        msg += `üì± *Telefone:* ${phone}\\n\\n`;
        msg += `üìç *Endere√ßo:*\\n${addressLine}\\n\\n`;
        msg += `üõí *Itens:*\\n`;
        orderDoc.items.forEach(i => {
          msg += `\\n${i.emoji || "üçΩÔ∏è"} ${i.qty}x ${i.name} ‚Äî ${moneyBR(i.price * i.qty)}`;
        });
        msg += `\\n\\nüí∞ *TOTAL: ${moneyBR(orderDoc.total)}*\\n`;
        msg += `\\n‚è±Ô∏è Tempo estimado: 45min a 1:20h`;

        const restPhone = digits(restaurant.whatsappPhone || "");
        const waUrl = restPhone
          ? `https://wa.me/${restPhone}?text=${encodeURIComponent(msg)}`
          : `https://wa.me/?text=${encodeURIComponent(msg)}`;

        window.closeCheckout();
        $("success-modal").classList.add("active");
        setTimeout(() => window.open(waUrl, "_blank", "noopener,noreferrer"), 450);

        $("checkout-form").reset();
        cart = [];
        updateCartUI();
      } catch (err) {
        console.error(err);
        $("checkout-error").classList.remove("hidden");
      }
    });

    // ==============================
    // Produtos
    // ==============================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeCategory(cat){
      const c = String(cat || "").trim().toLowerCase();
      if (c.includes("lanche")) return "Lanches";
      if (c.includes("pizza")) return "Pizzas";
      if (c.includes("bebida")) return "Bebidas";
      if (c.includes("sobrem")) return "Sobremesas";
      return "Lanches";
    }

    function renderProductCard(p){
      const emoji = p.emoji || "üçΩÔ∏è";
      const nameText = escapeHtml(p.name || "Produto");
      const desc = escapeHtml(p.description || "");
      const price = Number(p.price || 0);

      const safeName = (p.name || "Produto").replaceAll("\\", "\\\\").replaceAll("'", "\\'");
      const safeEmoji = (emoji || "üçΩÔ∏è").replaceAll("\\", "\\\\").replaceAll("'", "\\'");

      if (normalizeCategory(p.category) === "Bebidas") {
        return `
          <div class="menu-item rounded-xl p-3 text-center"
               onclick="addToCart('${safeName}', ${price}, '${safeEmoji}')"
               style="background:linear-gradient(135deg,#262626 0%,#1f1f1f 100%);border:1px solid #404040;">
            <div class="w-full aspect-[4/3] rounded-lg overflow-hidden mb-2" style="background:#0f0f0f;">
              ${p.imageUrl
                ? `<img src="${escapeHtml(p.imageUrl)}" alt="${nameText}" class="w-full h-full object-cover" loading="lazy">`
                : `<div class="w-full h-full flex items-center justify-center text-3xl">${emoji}</div>`}
            </div>
            <h3 class="font-medium" style="color:#fef3c7;">${nameText}</h3>
            <span class="text-lg font-bold" style="color:#d97706;">${moneyBR(price)}</span>
          </div>
        `;
      }

      return `
        <div class="menu-item rounded-xl p-4"
             onclick="addToCart('${safeName}', ${price}, '${safeEmoji}')"
             style="background:linear-gradient(135deg,#262626 0%,#1f1f1f 100%);border:1px solid #404040;">
          <div class="flex gap-4">
            <div class="w-24 h-24 rounded-xl overflow-hidden flex items-center justify-center"
                 style="background:#0f0f0f; border:1px solid #404040;">
              ${p.imageUrl
                ? `<img src="${escapeHtml(p.imageUrl)}" alt="${nameText}" class="w-full h-full object-cover" loading="lazy">`
                : `<span class="text-4xl">${emoji}</span>`}
            </div>

            <div class="flex-1">
              <div class="flex justify-between items-start gap-3">
                <h3 class="font-semibold text-lg" style="color:#fef3c7;">${nameText}</h3>
                <span class="text-2xl font-bold" style="color:#d97706;">${moneyBR(price)}</span>
              </div>

              ${desc ? `<p class="text-sm mt-1 opacity-80" style="color:#d6d3d1;">${desc}</p>` : ""}
              <p class="text-xs mt-2" style="color:#9ca3af;">Clique para adicionar ao carrinho</p>
            </div>
          </div>
        </div>
      `;
    }

    function clearSections(){
      ["Lanches","Pizzas","Bebidas","Sobremesas"].forEach(cat => {
        const el = document.getElementById(`products-${cat}`);
        if (el) el.innerHTML = "";
      });
    }

    function mountProducts(list){
      clearSections();
      const active = list.filter(p => p.isActive !== false);
      for (const p of active) {
        const cat = normalizeCategory(p.category);
        const container = document.getElementById(`products-${cat}`);
        if (!container) continue;
        container.insertAdjacentHTML("beforeend", renderProductCard(p));
      }
    }

    function startProductsRealtime(){
      if(!restaurantId || !productsRef) return;
      const qy = query(productsRef, orderBy("createdAt", "desc"));
      onSnapshot(qy, (snap) => {
        const products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        mountProducts(products);
      }, (err) => console.error("Falha ao ler products:", err));
    }

    async function loadCategoryTitles(){
      if(!restaurantId || !menuRef) return;
      try{
        const snap = await getDoc(menuRef);
        if(!snap.exists()) return;
        const data = snap.data() || {};
        const titles = data.categoryTitles || {};
        const setTitle = (key, elId) => {
          const el = document.getElementById(elId);
          if (!el) return;
          const v = titles[key];
          if (v && String(v).trim()) el.textContent = String(v).trim();
        };
        setTitle("Lanches", "title-Lanches");
        setTitle("Pizzas", "title-Pizzas");
        setTitle("Bebidas", "title-Bebidas");
        setTitle("Sobremesas", "title-Sobremesas");
      } catch(e){
        console.error("Erro ao carregar t√≠tulos:", e);
      }
    }

    // GAME
    const GAME_URL = "https://subway-surfers.gg/";
    window.openGame = function(){
      const modal = $("game-modal");
      const iframe = $("game-iframe");
      const fallback = $("game-fallback");
      const openTab = $("game-open-tab");
      openTab.href = GAME_URL;
      modal.classList.add("active");
      fallback.classList.add("hidden");
      iframe.src = GAME_URL;
      setTimeout(() => fallback.classList.remove("hidden"), 1200);
    };
    window.closeGame = function(){
      $("game-modal").classList.remove("active");
      $("game-iframe").src = "";
    };

    // INIT
    updateCartUI();
    const ok = await loadRestaurant();
    if (ok) {
      await loadCategoryTitles();
      startProductsRealtime();
    }
  </script>
</body>
</html>
