<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Restaurante (Admin)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; }
    * { scrollbar-width: thin; scrollbar-color: #d97706 #0b0b0b; }
    .card { background: linear-gradient(135deg,#1c1c1c 0%, #141414 100%); border: 1px solid #2c2c2c; border-radius: 18px; }
    .btn { border-radius: 14px; padding: 10px 12px; font-weight: 800; }
    .btn-primary { background: linear-gradient(135deg,#d97706 0%,#b45309 100%); color:#141414; }
    .btn-dark { background:#0f0f0f; border:1px solid #2c2c2c; color:#fde68a; }
    .btn-green { background: linear-gradient(135deg,#22c55e 0%,#16a34a 100%); color:#06140b; }
    .btn-blue { background: linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%); color:#0b1020; }
    .btn-red { background: linear-gradient(135deg,#ef4444 0%,#b91c1c 100%); color:#170505; }
    .btn-purple { background: linear-gradient(135deg,#a855f7 0%,#7c3aed 100%); color:#14051a; }
    .badge { border-radius: 999px; padding: 6px 10px; font-weight: 800; font-size: 12px; display:inline-flex; align-items:center; gap:6px; }
    .badge-new { background: rgba(217,119,6,.18); border:1px solid rgba(217,119,6,.35); color:#fde68a; }
    .badge-prep { background: rgba(59,130,246,.18); border:1px solid rgba(59,130,246,.35); color:#bfdbfe; }
    .badge-out { background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35); color:#bbf7d0; }
    .badge-done { background: rgba(168,85,247,.18); border:1px solid rgba(168,85,247,.35); color:#e9d5ff; }
    .badge-cancel { background: rgba(239,68,68,.16); border:1px solid rgba(239,68,68,.35); color:#fecaca; }
    .title { font-family:'Playfair Display', serif; }
    .input { width:100%; background:#0f0f0f; border:1px solid #2c2c2c; border-radius: 14px; padding: 12px 14px; color:#fef3c7; }
    .muted { color:#a3a3a3; }
    .divider { border-top: 1px solid #2c2c2c; }
    .tab-btn { border-radius: 999px; padding: 10px 14px; font-weight: 900; border:1px solid #2c2c2c; background:#0f0f0f; color:#fde68a; }
    .tab-btn.active { background: linear-gradient(135deg,#d97706 0%,#b45309 100%); color:#141414; border-color: rgba(217,119,6,.65); }
    .modal-overlay{
      position: fixed; inset:0; background: rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center;
      z-index: 9998; padding: 16px;
    }
    .modal-overlay.active{ display:flex; }
    .thumb{ width:64px; height:64px; border-radius:14px; object-fit:cover; border:1px solid #2c2c2c; background:#0f0f0f; }
    .pill{ padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid #2c2c2c; background:#0f0f0f; color:#fde68a; }
  </style>
</head>

<body class="h-full bg-black text-white">

  <!-- LOGIN OVERLAY -->
  <div id="login-overlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 p-4">
    <div class="card w-full max-w-md p-6">
      <h2 class="text-2xl font-extrabold title" style="color:#fde68a;">üîí Entrar no Painel</h2>
      <p class="text-sm muted mt-1">Use o email e senha cadastrados no Firebase Auth.</p>

      <div class="mt-5 space-y-3">
        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Email</label>
          <input id="login-email" class="input mt-2" type="email" placeholder="restaurante@email.com" autocomplete="username" />
        </div>
        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Senha</label>
          <input id="login-pass" class="input mt-2" type="password" placeholder="********" autocomplete="current-password" />
        </div>

        <button id="login-btn" class="btn btn-primary w-full mt-2">Entrar</button>
        <p id="login-error" class="text-sm mt-2 hidden" style="color:#ef4444;">Email ou senha inv√°lidos.</p>
      </div>
    </div>
  </div>

  <div id="app" class="min-h-screen hidden">
    <!-- Topbar -->
    <header class="sticky top-0 z-50 backdrop-blur bg-black/70 border-b border-neutral-800">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-3">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold title" style="color:#fde68a;">Painel do Restaurante</h1>
            <p class="text-sm muted">Pedidos em tempo real + Produtos + Dashboard (Firebase)</p>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="btn-refresh" class="btn btn-dark">üîÑ Atualizar</button>
            <button id="btn-logout" class="btn btn-red">Sair</button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap gap-2">
          <button class="tab-btn active" data-tab="tab-orders">üßæ Pedidos</button>
          <button class="tab-btn" data-tab="tab-products">üçΩÔ∏è Produtos</button>
          <button class="tab-btn" data-tab="tab-dashboard">üìä Dashboard</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">

      <!-- =========================
           TAB: ORDERS (SEU ORIGINAL)
           ========================= -->
      <section id="tab-orders" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left: Orders -->
        <section class="lg:col-span-8 space-y-6">
          <!-- Filters -->
          <div class="card p-5">
            <div class="flex flex-col md:flex-row md:items-end gap-4">
              <div class="flex-1">
                <label class="text-sm font-semibold" style="color:#fde68a;">Buscar (nome / telefone / item)</label>
                <input id="search" class="input mt-2" placeholder="Ex: Jo√£o, 1199..., Smash..." />
              </div>

              <div class="w-full md:w-56">
                <label class="text-sm font-semibold" style="color:#fde68a;">Status</label>
                <select id="filter-status" class="input mt-2">
                  <option value="all">Todos</option>
                  <option value="new">Novo</option>
                  <option value="preparing">Preparando</option>
                  <option value="out_for_delivery">Saiu p/ entrega</option>
                  <option value="done">Feito</option>
                  <option value="cancelled">Cancelado</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Orders list -->
          <div class="card p-5">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Fila de Pedidos</h2>
              <span id="orders-count" class="badge badge-new">üßæ 0 pedido(s)</span>
            </div>

            <div id="orders-empty" class="mt-6 p-6 rounded-xl bg-neutral-950 border border-neutral-800 text-center hidden">
              <p class="text-lg font-bold" style="color:#fde68a;">Nenhum pedido ainda</p>
              <p class="text-sm muted mt-1">Quando o cliente enviar, ele aparece aqui.</p>
            </div>

            <div id="orders-list" class="mt-5 space-y-4"></div>
          </div>
        </section>

        <!-- Right: Quick + Mini Metrics -->
        <section class="lg:col-span-4 space-y-6">
          <div class="card p-5">
            <h2 class="text-xl font-bold title" style="color:#fde68a;">A√ß√µes r√°pidas</h2>
            <p class="text-sm muted mt-2">Dica: clique em ‚ÄúAbrir WhatsApp‚Äù em um pedido para responder r√°pido.</p>
            <div class="divider my-5"></div>
            <p class="text-xs muted">Obs.: WhatsApp oficial (API) precisa de backend para token. Aqui abrimos o WhatsApp Web/App com a mensagem pronta.</p>
          </div>

          <div class="card p-5">
            <h2 class="text-xl font-bold title" style="color:#fde68a;">Resumo r√°pido</h2>
            <div class="divider my-4"></div>

            <div class="grid grid-cols-2 gap-3">
              <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                <p class="text-xs muted">Total de pedidos</p>
                <p id="m-total" class="text-2xl font-extrabold" style="color:#fde68a;">0</p>
              </div>
              <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                <p class="text-xs muted">Faturamento (sem cancelados)</p>
                <p id="m-revenue" class="text-2xl font-extrabold" style="color:#d97706;">R$ 0,00</p>
              </div>
              <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                <p class="text-xs muted">Novos</p>
                <p id="m-new" class="text-2xl font-extrabold" style="color:#fde68a;">0</p>
              </div>
              <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                <p class="text-xs muted">Cancelados</p>
                <p id="m-cancel" class="text-2xl font-extrabold" style="color:#ef4444;">0</p>
              </div>
            </div>

            <div class="divider my-4"></div>
            <p class="text-xs muted">Para ver mais m√©tricas e top produtos, abra a aba ‚ÄúDashboard‚Äù.</p>
          </div>
        </section>
      </section>

      <!-- =========================
           TAB: PRODUCTS (CRUD)
           ========================= -->
      <section id="tab-products" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- Left: products list -->
          <section class="lg:col-span-8 space-y-6">
            <div class="card p-5">
              <div class="flex flex-col md:flex-row md:items-end gap-4">
                <div class="flex-1">
                  <label class="text-sm font-semibold" style="color:#fde68a;">Buscar produto</label>
                  <input id="prod-search" class="input mt-2" placeholder="Ex: Pizza, Smash, Suco..." />
                </div>

                <div class="w-full md:w-56">
                  <label class="text-sm font-semibold" style="color:#fde68a;">Categoria</label>
                  <select id="prod-filter-category" class="input mt-2">
                    <option value="all">Todas</option>
                    <option value="Lanches">Lanches</option>
                    <option value="Pizzas">Pizzas</option>
                    <option value="Bebidas">Bebidas</option>
                    <option value="Sobremesas">Sobremesas</option>
                  </select>
                </div>

                <button id="btn-open-new" class="btn btn-primary w-full md:w-auto">‚ûï Novo produto</button>
              </div>
            </div>

            <div class="card p-5">
              <div class="flex items-center justify-between gap-3">
                <h2 class="text-xl font-bold title" style="color:#fde68a;">Produtos do Card√°pio</h2>
                <span id="products-count" class="badge badge-new">üçΩÔ∏è 0 produto(s)</span>
              </div>

              <div id="products-empty" class="mt-6 p-6 rounded-xl bg-neutral-950 border border-neutral-800 text-center hidden">
                <p class="text-lg font-bold" style="color:#fde68a;">Nenhum produto cadastrado</p>
                <p class="text-sm muted mt-1">Clique em ‚ÄúNovo produto‚Äù para criar.</p>
              </div>

              <div id="products-list" class="mt-5 space-y-4"></div>
            </div>
          </section>

          <!-- Right: tips -->
          <section class="lg:col-span-4 space-y-6">
            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Fotos do produto</h2>
              <p class="text-sm muted mt-2">
                Voc√™ pode:
                <br>‚Ä¢ Colar uma URL de imagem (ImageKit, Imgur, etc.)
                <br>‚Ä¢ Ou fazer upload no Firebase Storage (se estiver ativado).
              </p>
              <div class="divider my-5"></div>
              <p class="text-xs muted">
                Importante: para o site (index.html) mostrar os produtos do Firestore automaticamente,
                voc√™ precisa alterar o index para ‚Äúler‚Äù a cole√ß√£o <b>products</b>.
              </p>
            </div>

            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Cole√ß√µes</h2>
              <div class="divider my-4"></div>
              <p class="text-sm muted">
                ‚Ä¢ orders (pedidos)
                <br>‚Ä¢ products (card√°pio)
              </p>
              <p class="text-xs muted mt-3">
                Se algo n√£o aparecer, normalmente √© regra do Firestore bloqueando (rules).
              </p>
            </div>
          </section>
        </div>
      </section>

      <!-- =========================
           TAB: DASHBOARD (M√âTRICAS)
           ========================= -->
      <section id="tab-dashboard" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <!-- metrics -->
          <section class="lg:col-span-8 space-y-6">
            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">M√©tricas de Vendas</h2>
              <p class="text-sm muted mt-1">Atualiza em tempo real conforme os pedidos entram e mudam de status.</p>

              <div class="divider my-5"></div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Total pedidos</p>
                  <p id="d-total" class="text-3xl font-extrabold" style="color:#fde68a;">0</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Faturamento (sem cancelados)</p>
                  <p id="d-revenue" class="text-3xl font-extrabold" style="color:#d97706;">R$ 0,00</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Ticket m√©dio</p>
                  <p id="d-ticket" class="text-3xl font-extrabold" style="color:#fde68a;">R$ 0,00</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Conclu√≠dos</p>
                  <p id="d-done" class="text-3xl font-extrabold" style="color:#a855f7;">0</p>
                </div>
              </div>

              <div class="divider my-5"></div>

              <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Novos</p>
                  <p id="d-new" class="text-2xl font-extrabold" style="color:#fde68a;">0</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Preparando</p>
                  <p id="d-prep" class="text-2xl font-extrabold" style="color:#3b82f6;">0</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Saiu p/ entrega</p>
                  <p id="d-out" class="text-2xl font-extrabold" style="color:#22c55e;">0</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Feitos</p>
                  <p id="d-done2" class="text-2xl font-extrabold" style="color:#a855f7;">0</p>
                </div>
                <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                  <p class="text-xs muted">Cancelados</p>
                  <p id="d-cancel" class="text-2xl font-extrabold" style="color:#ef4444;">0</p>
                </div>
              </div>
            </div>

            <div class="card p-5">
              <div class="flex items-center justify-between gap-3">
                <h2 class="text-xl font-bold title" style="color:#fde68a;">Top Itens Vendidos</h2>
                <span class="pill">üî• baseado nos pedidos</span>
              </div>
              <div class="divider my-4"></div>
              <div id="top-items" class="space-y-3"></div>
              <p class="text-xs muted mt-4">Dica: se quiser ‚Äúpor per√≠odo‚Äù (dia/semana/m√™s), d√° para evoluir depois.</p>
            </div>
          </section>

          <!-- right -->
          <section class="lg:col-span-4 space-y-6">
            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Sa√∫de do Neg√≥cio</h2>
              <div class="divider my-4"></div>

              <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
                <p class="text-xs muted">Taxa de cancelamento</p>
                <p id="d-cancel-rate" class="text-2xl font-extrabold" style="color:#ef4444;">0%</p>
              </div>

              <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800 mt-3">
                <p class="text-xs muted">Taxa de conclus√£o</p>
                <p id="d-done-rate" class="text-2xl font-extrabold" style="color:#a855f7;">0%</p>
              </div>

              <div class="divider my-5"></div>
              <p class="text-xs muted">
                Obs.: estas m√©tricas s√£o calculadas a partir do que est√° salvo no Firestore.
              </p>
            </div>

            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Atalho</h2>
              <div class="divider my-4"></div>
              <button class="btn btn-primary w-full" id="go-products">üçΩÔ∏è Gerenciar produtos</button>
              <button class="btn btn-dark w-full mt-2" id="go-orders">üßæ Voltar para pedidos</button>
            </div>
          </section>
        </div>
      </section>

    </main>
  </div>

  <!-- =========================
       MODAL: NEW/EDIT PRODUCT
       ========================= -->
  <div id="product-modal" class="modal-overlay">
    <div class="card w-full max-w-2xl p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 id="prod-modal-title" class="text-2xl font-extrabold title" style="color:#fde68a;">üçΩÔ∏è Novo produto</h2>
          <p class="text-sm muted mt-1">Crie, edite, coloque foto e organize no card√°pio.</p>
        </div>
        <button id="btn-close-prod-modal" class="btn btn-dark">‚úñ</button>
      </div>

      <div class="divider my-5"></div>

      <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="prod-id" value="" />

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">Nome</label>
          <input id="prod-name" class="input mt-2" placeholder="Ex: Smash Burger Especial" required />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">Descri√ß√£o</label>
          <textarea id="prod-desc" class="input mt-2" rows="3" placeholder="Ex: 2x smash 90g, cheddar, bacon..." required></textarea>
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Pre√ßo (R$)</label>
          <input id="prod-price" class="input mt-2" type="number" step="0.01" min="0" placeholder="32.90" required />
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Categoria</label>
          <select id="prod-category" class="input mt-2" required>
            <option value="Lanches">Lanches</option>
            <option value="Pizzas">Pizzas</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Sobremesas">Sobremesas</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">Emoji (opcional)</label>
          <input id="prod-emoji" class="input mt-2" placeholder="üçî üçï ü•§ üç∞" maxlength="4" />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">URL da imagem (opcional)</label>
          <input id="prod-image-url" class="input mt-2" placeholder="https://..." />
          <p class="text-xs muted mt-2">Se voc√™ fizer upload abaixo, a URL ser√° preenchida automaticamente (se Storage estiver ativo).</p>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">Upload de imagem (opcional)</label>
          <input id="prod-image-file" class="input mt-2" type="file" accept="image/*" />
          <button id="btn-upload-image" type="button" class="btn btn-purple w-full mt-2">‚¨ÜÔ∏è Enviar imagem para o Storage</button>
          <p id="upload-hint" class="text-xs muted mt-2">Se o upload falhar, use uma URL de imagem.</p>
        </div>

        <div class="md:col-span-2 flex flex-col md:flex-row gap-2 mt-2">
          <button id="btn-save-product" type="submit" class="btn btn-primary w-full">Salvar</button>
          <button id="btn-delete-product" type="button" class="btn btn-red w-full hidden">Excluir</button>
        </div>

        <p id="prod-form-error" class="md:col-span-2 text-sm hidden" style="color:#ef4444;">Erro ao salvar. Verifique regras/Storage e tente novamente.</p>
      </form>
    </div>
  </div>

  <script type="module">
    // ==============================
    // FIREBASE (CDN - modular v10.12.2)
    // ==============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      updateDoc,
      addDoc,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ‚úÖ SEU firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyBqFZJ5wg3VIJlJtA4DgFS499_9rXu-zAk",
      authDomain: "cardapio-digital-adc3d.firebaseapp.com",
      projectId: "cardapio-digital-adc3d",
      storageBucket: "cardapio-digital-adc3d.firebasestorage.app",
      messagingSenderId: "762370492160",
      appId: "1:762370492160:web:86a86687c52a76f56895e5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Storage (opcional, mas habilita upload se voc√™ ativar no Firebase)
    const storage = getStorage(app);

    // ==============================
    // UI HELPERS
    // ==============================
    const $ = (id) => document.getElementById(id);

    function moneyBR(value){
      const n = Number(value || 0);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function statusBadge(status){
      if(status === "new") return `<span class="badge badge-new">üÜï Novo</span>`;
      if(status === "preparing") return `<span class="badge badge-prep">üë®‚Äçüç≥ Preparando</span>`;
      if(status === "out_for_delivery") return `<span class="badge badge-out">üöö Saiu</span>`;
      if(status === "done") return `<span class="badge badge-done">‚úÖ Feito</span>`;
      if(status === "cancelled") return `<span class="badge badge-cancel">‚õî Cancelado</span>`;
      return `<span class="badge badge-new">üÜï Novo</span>`;
    }

    function normalizePhoneBR(phone){
      const digits = String(phone || "").replace(/\D/g, "");
      if(!digits) return "";
      if(digits.startsWith("55")) return digits;
      return "55" + digits;
    }

    function buildWhatsAppLink(order){
      const items = (order.items||[])
        .map(i => `- ${i.qty}x ${i.name} (${moneyBR((i.price||0) * (i.qty||0))})`)
        .join("\n");

      const text =
`‚úÖ Pedido recebido!
Cliente: ${order.customer?.name || ""}
Telefone: ${order.customer?.phone || ""}
Endere√ßo: ${order.customer?.addressLine || ""}

Itens:
${items}

Total: ${moneyBR(order.total || 0)}

Responda aqui para confirmar.`;

      const phone = normalizePhoneBR(order.customer?.phone || "");
      return phone
        ? `https://wa.me/${phone}?text=${encodeURIComponent(text)}`
        : `https://wa.me/?text=${encodeURIComponent(text)}`;
    }

    // ==============================
    // TABS
    // ==============================
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
    function openTab(tabId){
      ["tab-orders","tab-products","tab-dashboard"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.classList.toggle("hidden", id !== tabId);
      });
      tabButtons.forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-tab") === tabId);
      });
    }
    tabButtons.forEach(b=>{
      b.addEventListener("click", ()=> openTab(b.getAttribute("data-tab")));
    });
    $("go-products")?.addEventListener("click", ()=> openTab("tab-products"));
    $("go-orders")?.addEventListener("click", ()=> openTab("tab-orders"));

    // ==============================
    // AUTH FLOW
    // ==============================
    async function doLogin(){
      $("login-error").classList.add("hidden");
      const email = ($("login-email").value || "").trim();
      const pass = ($("login-pass").value || "").trim();
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        $("login-error").classList.remove("hidden");
      }
    }

    $("login-btn").addEventListener("click", doLogin);
    $("login-pass").addEventListener("keydown", (e) => { if(e.key === "Enter") doLogin(); });
    $("btn-logout").addEventListener("click", async () => { await signOut(auth); });

    // ==============================
    // ORDERS (REALTIME)
    // ==============================
    let unsubOrders = null;
    let liveOrders = [];

    function applyFiltersOrders(orders){
      const q = ($("search").value || "").toLowerCase().trim();
      const st = $("filter-status").value;

      let list = [...orders];
      if(st !== "all") list = list.filter(o => o.status === st);

      if(q){
        list = list.filter(o => {
          const itemsText = (o.items || []).map(i => i.name).join(" ");
          return (
            (o.customer?.name || "").toLowerCase().includes(q) ||
            (o.customer?.phone || "").toLowerCase().includes(q) ||
            itemsText.toLowerCase().includes(q)
          );
        });
      }
      return list;
    }

    async function setOrderStatus(orderId, status){
      const ref = doc(db, "orders", orderId);
      await updateDoc(ref, { status, updatedAt: serverTimestamp() });
    }

    function renderOrders(){
      const list = applyFiltersOrders(liveOrders);

      $("orders-count").textContent = `üßæ ${list.length} pedido(s)`;
      $("orders-empty").classList.toggle("hidden", list.length !== 0);

      $("orders-list").innerHTML = list.map(o => {
        let createdDate = new Date();
        if (o.createdAt?.toDate) createdDate = o.createdAt.toDate();
        else if (typeof o.createdAt === "string") createdDate = new Date(o.createdAt);
        const time = createdDate.toLocaleString("pt-BR");

        const itemsHtml = (o.items || []).map(i =>
          `<li class="flex justify-between gap-3">
             <span class="text-sm" style="color:#fef3c7;">${Number(i.qty||0)}x ${escapeHtml(i.name)}</span>
             <span class="text-sm font-bold" style="color:#d97706;">${moneyBR((i.price||0) * (i.qty||0))}</span>
           </li>`
        ).join("");

        const waLink = buildWhatsAppLink(o);
        const shortId = (o.id || "").slice(-6).toUpperCase() || "------";

        return `
          <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
              <div>
                <div class="flex items-center gap-2 flex-wrap">
                  <p class="font-extrabold" style="color:#fde68a;">Pedido #${escapeHtml(shortId)}</p>
                  ${statusBadge(o.status)}
                </div>
                <p class="text-sm muted mt-1">${time}</p>

                <div class="mt-3 text-sm">
                  <p style="color:#fef3c7;"><span class="muted">Cliente:</span> <b>${escapeHtml(o.customer?.name || "‚Äî")}</b></p>
                  <p style="color:#fef3c7;"><span class="muted">Telefone:</span> <b>${escapeHtml(o.customer?.phone || "‚Äî")}</b></p>
                  <p class="mt-2 muted">Endere√ßo:</p>
                  <p style="color:#fef3c7;">${escapeHtml(o.customer?.addressLine || "‚Äî")}</p>
                </div>
              </div>

              <div class="min-w-[240px]">
                <div class="p-3 rounded-xl bg-black border border-neutral-800">
                  <p class="text-xs muted">Total</p>
                  <p class="text-2xl font-extrabold" style="color:#d97706;">${moneyBR(o.total || 0)}</p>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-3">
                  <button class="btn btn-dark" data-act="prep" data-id="${o.id}">üë®‚Äçüç≥ Preparando</button>
                  <button class="btn btn-blue" data-act="out" data-id="${o.id}">üöö Saiu</button>
                  <button class="btn btn-green" data-act="done" data-id="${o.id}">‚úÖ Feito</button>
                  <button class="btn btn-red" data-act="cancel" data-id="${o.id}">‚õî Cancelar</button>
                </div>

                <a class="btn btn-dark w-full mt-2 block text-center" href="${waLink}" target="_blank" rel="noopener">üí¨ Abrir WhatsApp</a>
              </div>
            </div>

            <div class="divider my-4"></div>

            <div>
              <p class="text-sm font-bold" style="color:#fde68a;">Itens</p>
              <ul class="mt-2 space-y-2">${itemsHtml}</ul>
            </div>
          </div>
        `;
      }).join("");

      $("orders-list").querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          const map = {
            prep: "preparing",
            out: "out_for_delivery",
            done: "done",
            cancel: "cancelled"
          };
          await setOrderStatus(id, map[act] || "new");
        });
      });
    }

    function startOrdersRealtime(){
      if(unsubOrders) unsubOrders();
      const qy = query(collection(db, "orders"), orderBy("createdAt", "desc"));
      unsubOrders = onSnapshot(qy, (snap) => {
        liveOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderOrders();
        updateMetricsFromOrders(liveOrders);
      }, () => {});
    }

    $("btn-refresh").addEventListener("click", () => {
      renderOrders();
      renderProducts();
      updateMetricsFromOrders(liveOrders);
    });
    $("search").addEventListener("input", () => renderOrders());
    $("filter-status").addEventListener("change", () => renderOrders());

    // ==============================
    // METRICS (DASHBOARD)
    // ==============================
    function updateText(id, val){
      const el = $(id);
      if(el) el.textContent = val;
    }

    function updateMetricsFromOrders(orders){
      const total = orders.length;
      const count = {
        new: 0,
        preparing: 0,
        out_for_delivery: 0,
        done: 0,
        cancelled: 0
      };

      let revenue = 0;
      let doneRevenue = 0;

      const itemAgg = new Map(); // name -> {qty, total}

      orders.forEach(o => {
        const st = o.status || "new";
        if(count[st] != null) count[st]++;

        const orderTotal = Number(o.total || 0);
        if(st !== "cancelled") revenue += orderTotal;
        if(st === "done") doneRevenue += orderTotal;

        (o.items || []).forEach(it => {
          const key = String(it.name || "").trim();
          if(!key) return;
          const qty = Number(it.qty || 0);
          const lineTotal = Number(it.price || 0) * qty;
          const prev = itemAgg.get(key) || { qty: 0, total: 0 };
          prev.qty += qty;
          prev.total += lineTotal;
          itemAgg.set(key, prev);
        });
      });

      // Quick (Orders tab)
      updateText("m-total", String(total));
      updateText("m-new", String(count.new));
      updateText("m-cancel", String(count.cancelled));
      updateText("m-revenue", moneyBR(revenue));

      // Dashboard
      updateText("d-total", String(total));
      updateText("d-revenue", moneyBR(revenue));
      updateText("d-new", String(count.new));
      updateText("d-prep", String(count.preparing));
      updateText("d-out", String(count.out_for_delivery));
      updateText("d-done", String(count.done));
      updateText("d-done2", String(count.done));
      updateText("d-cancel", String(count.cancelled));

      const nonCancelledCount = total - count.cancelled;
      const ticket = nonCancelledCount > 0 ? (revenue / nonCancelledCount) : 0;
      updateText("d-ticket", moneyBR(ticket));

      const cancelRate = total > 0 ? (count.cancelled / total) * 100 : 0;
      const doneRate = total > 0 ? (count.done / total) * 100 : 0;
      updateText("d-cancel-rate", `${cancelRate.toFixed(1)}%`);
      updateText("d-done-rate", `${doneRate.toFixed(1)}%`);

      // Top items
      const top = Array.from(itemAgg.entries())
        .map(([name, v]) => ({ name, qty: v.qty, total: v.total }))
        .sort((a,b)=> b.qty - a.qty)
        .slice(0, 10);

      const topEl = $("top-items");
      if(topEl){
        if(top.length === 0){
          topEl.innerHTML = `<div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
            <p class="text-sm muted">Sem itens ainda (fa√ßa um pedido para gerar estat√≠stica).</p>
          </div>`;
        } else {
          topEl.innerHTML = top.map((t, idx)=>`
            <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800 flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center font-extrabold"
                     style="background: rgba(217,119,6,.18); border:1px solid rgba(217,119,6,.35); color:#fde68a;">
                  ${idx+1}
                </div>
                <div>
                  <p class="font-extrabold" style="color:#fef3c7;">${escapeHtml(t.name)}</p>
                  <p class="text-xs muted">${t.qty} unidade(s) ‚Ä¢ ${moneyBR(t.total)}</p>
                </div>
              </div>
              <span class="pill">üî• ${t.qty}</span>
            </div>
          `).join("");
        }
      }
    }

    // ==============================
    // PRODUCTS (CRUD - Firestore)
    // ==============================
    let unsubProducts = null;
    let liveProducts = [];

    function openProductModal(mode, product){
      $("prod-form-error").classList.add("hidden");
      $("product-modal").classList.add("active");

      if(mode === "edit"){
        $("prod-modal-title").textContent = "‚úèÔ∏è Editar produto";
        $("prod-id").value = product.id || "";
        $("prod-name").value = product.name || "";
        $("prod-desc").value = product.description || "";
        $("prod-price").value = String(product.price ?? "");
        $("prod-category").value = product.category || "Lanches";
        $("prod-emoji").value = product.emoji || "";
        $("prod-image-url").value = product.imageUrl || "";
        $("btn-delete-product").classList.remove("hidden");
      } else {
        $("prod-modal-title").textContent = "üçΩÔ∏è Novo produto";
        $("prod-id").value = "";
        $("product-form").reset();
        $("prod-category").value = "Lanches";
        $("btn-delete-product").classList.add("hidden");
      }
    }

    function closeProductModal(){
      $("product-modal").classList.remove("active");
      $("prod-image-file").value = "";
    }

    $("btn-open-new").addEventListener("click", ()=> openProductModal("new"));
    $("btn-close-prod-modal").addEventListener("click", closeProductModal);
    $("product-modal").addEventListener("click", (e)=>{ if(e.target === $("product-modal")) closeProductModal(); });

    function applyProductFilters(list){
      const q = ($("prod-search").value || "").toLowerCase().trim();
      const cat = $("prod-filter-category").value;

      let out = [...list];
      if(cat !== "all") out = out.filter(p => (p.category || "") === cat);

      if(q){
        out = out.filter(p => {
          const text = `${p.name||""} ${p.description||""} ${p.category||""}`.toLowerCase();
          return text.includes(q);
        });
      }
      return out;
    }

    function renderProducts(){
      const filtered = applyProductFilters(liveProducts);

      $("products-count").textContent = `üçΩÔ∏è ${filtered.length} produto(s)`;
      $("products-empty").classList.toggle("hidden", filtered.length !== 0);

      const box = $("products-list");
      if(!box) return;

      box.innerHTML = filtered.map(p=>{
        const img = p.imageUrl ? escapeHtml(p.imageUrl) : "";
        const emoji = p.emoji ? escapeHtml(p.emoji) : "üçΩÔ∏è";

        return `
          <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="flex items-start gap-4">
                <img class="thumb" src="${img || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' fill='%230f0f0f'/%3E%3Ctext x='50%25' y='52%25' dominant-baseline='middle' text-anchor='middle' fill='%23fde68a' font-size='18'%3E%F0%9F%8D%BD%EF%B8%8F%3C/text%3E%3C/svg%3E"}" alt="Foto produto" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Crect width=%2264%22 height=%2264%22 fill=%220f0f0f%22/%3E%3Ctext x=%2250%25%22 y=%2252%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22fde68a%22 font-size=%2218%22%3E%F0%9F%8D%BD%EF%B8%8F%3C/text%3E%3C/svg%3E';" />
                <div class="flex-1">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="pill">${emoji}</span>
                    <p class="font-extrabold" style="color:#fef3c7;">${escapeHtml(p.name || "Sem nome")}</p>
                    <span class="pill">${escapeHtml(p.category || "‚Äî")}</span>
                  </div>
                  <p class="text-sm muted mt-2">${escapeHtml(p.description || "")}</p>
                  <p class="text-lg font-extrabold mt-3" style="color:#d97706;">${moneyBR(p.price || 0)}</p>
                </div>
              </div>

              <div class="min-w-[240px]">
                <button class="btn btn-primary w-full" data-prod-act="edit" data-prod-id="${p.id}">‚úèÔ∏è Editar</button>
                <button class="btn btn-red w-full mt-2" data-prod-act="del" data-prod-id="${p.id}">üóëÔ∏è Excluir</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      box.querySelectorAll("[data-prod-act='edit']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-prod-id");
          const p = liveProducts.find(x=> x.id === id);
          if(p) openProductModal("edit", p);
        });
      });

      box.querySelectorAll("[data-prod-act='del']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-prod-id");
          const p = liveProducts.find(x=> x.id === id);
          const ok = confirm(`Excluir o produto "${p?.name || "Sem nome"}"?`);
          if(!ok) return;
          try{
            await deleteDoc(doc(db, "products", id));
          }catch(e){
            alert("N√£o foi poss√≠vel excluir. Verifique regras do Firestore.");
          }
        });
      });
    }

    function startProductsRealtime(){
      if(unsubProducts) unsubProducts();
      const qy = query(collection(db, "products"), orderBy("createdAt", "desc"));
      unsubProducts = onSnapshot(qy, (snap)=>{
        liveProducts = snap.docs.map(d=>({ id: d.id, ...d.data() }));
        renderProducts();
      }, ()=>{});
    }

    $("prod-search").addEventListener("input", renderProducts);
    $("prod-filter-category").addEventListener("change", renderProducts);

    // Upload image -> Storage -> set URL
    $("btn-upload-image").addEventListener("click", async ()=>{
      $("prod-form-error").classList.add("hidden");
      const file = $("prod-image-file").files?.[0];
      if(!file){
        alert("Selecione uma imagem primeiro.");
        return;
      }

      try{
        const safeName = file.name.replace(/[^\w.\-]+/g, "_");
        const path = `products/${Date.now()}_${safeName}`;
        const storageRef = ref(storage, path);

        $("btn-upload-image").textContent = "Enviando...";
        $("btn-upload-image").disabled = true;

        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        $("prod-image-url").value = url;
        $("upload-hint").textContent = "‚úÖ Upload conclu√≠do! URL preenchida.";
      }catch(e){
        $("upload-hint").textContent = "‚ö†Ô∏è Upload falhou. Use uma URL de imagem (ou ative o Storage/regras).";
      }finally{
        $("btn-upload-image").textContent = "‚¨ÜÔ∏è Enviar imagem para o Storage";
        $("btn-upload-image").disabled = false;
      }
    });

    // Save product (create/update)
    $("product-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("prod-form-error").classList.add("hidden");

      const id = ($("prod-id").value || "").trim();
      const payload = {
        name: ($("prod-name").value || "").trim(),
        description: ($("prod-desc").value || "").trim(),
        price: Number($("prod-price").value || 0),
        category: ($("prod-category").value || "Lanches"),
        emoji: ($("prod-emoji").value || "").trim(),
        imageUrl: ($("prod-image-url").value || "").trim(),
        updatedAt: serverTimestamp()
      };

      try{
        if(id){
          await updateDoc(doc(db, "products", id), payload);
        } else {
          await addDoc(collection(db, "products"), {
            ...payload,
            createdAt: serverTimestamp()
          });
        }
        closeProductModal();
      }catch(err){
        $("prod-form-error").classList.remove("hidden");
      }
    });

    // Delete inside modal
    $("btn-delete-product").addEventListener("click", async ()=>{
      const id = ($("prod-id").value || "").trim();
      if(!id) return;
      const ok = confirm("Excluir este produto?");
      if(!ok) return;
      try{
        await deleteDoc(doc(db, "products", id));
        closeProductModal();
      }catch(e){
        $("prod-form-error").classList.remove("hidden");
      }
    });

    // ==============================
    // AUTH STATE
    // ==============================
    onAuthStateChanged(auth, (user) => {
      if(user){
        $("login-overlay").classList.add("hidden");
        $("app").classList.remove("hidden");

        // default tab
        openTab("tab-orders");

        startOrdersRealtime();
        startProductsRealtime();
      } else {
        $("app").classList.add("hidden");
        $("login-overlay").classList.remove("hidden");

        if(unsubOrders) unsubOrders();
        unsubOrders = null;
        liveOrders = [];
        $("orders-list").innerHTML = "";
        $("orders-count").textContent = "üßæ 0 pedido(s)";
        $("orders-empty").classList.add("hidden");

        if(unsubProducts) unsubProducts();
        unsubProducts = null;
        liveProducts = [];
        $("products-list").innerHTML = "";
        $("products-count").textContent = "üçΩÔ∏è 0 produto(s)";
        $("products-empty").classList.add("hidden");

        updateMetricsFromOrders([]);
      }
    });
  </script>

  <!-- ‚úÖ IMPORTANTE (REGRAS) -->
  <!--
    Para o admin conseguir LER/ESCREVER em products, suas rules precisam permitir:

    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /orders/{id} { allow read, write: if request.auth != null; }
        match /products/{id} { allow read, write: if request.auth != null; }
      }
    }

    (Cole em: Firestore Database > Regras > Publish)
  -->
</body>
</html>
