<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Restaurante (Admin)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; }
    * { scrollbar-width: thin; scrollbar-color: #d97706 #0b0b0b; }
    .card { background: linear-gradient(135deg,#1c1c1c 0%, #141414 100%); border: 1px solid #2c2c2c; border-radius: 18px; }
    .btn { border-radius: 14px; padding: 10px 12px; font-weight: 800; }
    .btn-primary { background: linear-gradient(135deg,#d97706 0%,#b45309 100%); color:#141414; }
    .btn-dark { background:#0f0f0f; border:1px solid #2c2c2c; color:#fde68a; }
    .btn-green { background: linear-gradient(135deg,#22c55e 0%,#16a34a 100%); color:#06140b; }
    .btn-blue { background: linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%); color:#0b1020; }
    .btn-red { background: linear-gradient(135deg,#ef4444 0%,#b91c1c 100%); color:#170505; }
    .badge { border-radius: 999px; padding: 6px 10px; font-weight: 800; font-size: 12px; display:inline-flex; align-items:center; gap:6px; }
    .badge-new { background: rgba(217,119,6,.18); border:1px solid rgba(217,119,6,.35); color:#fde68a; }
    .badge-prep { background: rgba(59,130,246,.18); border:1px solid rgba(59,130,246,.35); color:#bfdbfe; }
    .badge-out { background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35); color:#bbf7d0; }
    .badge-done { background: rgba(168,85,247,.18); border:1px solid rgba(168,85,247,.35); color:#e9d5ff; }
    .badge-cancel { background: rgba(239,68,68,.16); border:1px solid rgba(239,68,68,.35); color:#fecaca; }
    .title { font-family:'Playfair Display', serif; }
    .input { width:100%; background:#0f0f0f; border:1px solid #2c2c2c; border-radius: 14px; padding: 12px 14px; color:#fef3c7; }
    .muted { color:#a3a3a3; }
    .divider { border-top: 1px solid #2c2c2c; }
    .tab-btn { padding: 10px 14px; border-radius: 14px; font-weight: 900; border: 1px solid #2c2c2c; background:#0f0f0f; color:#fde68a; }
    .tab-btn.active { background: linear-gradient(135deg,#d97706 0%,#b45309 100%); color:#141414; border-color: rgba(217,119,6,.45); }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index: 9999; padding: 16px;}
    .modal-overlay.active { display:flex; }
    .imgbox { width: 72px; height:72px; border-radius: 14px; background:#0b0b0b; border:1px solid #2c2c2c; overflow:hidden; flex:0 0 auto; display:flex; align-items:center; justify-content:center; color:#a3a3a3; font-weight:900;}
    .imgbox img{ width:100%; height:100%; object-fit:cover; display:block; }
  </style>
</head>

<body class="h-full bg-black text-white">

  <!-- LOGIN -->
  <div id="login-overlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 p-4">
    <div class="card w-full max-w-md p-6">
      <h2 class="text-2xl font-extrabold title" style="color:#fde68a;">ğŸ”’ Entrar no Painel</h2>
      <p class="text-sm muted mt-1">Use o email e senha cadastrados no Firebase Auth.</p>

      <div class="mt-5 space-y-3">
        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Email</label>
          <input id="login-email" class="input mt-2" type="email" placeholder="restaurante@email.com" autocomplete="username" />
        </div>
        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Senha</label>
          <input id="login-pass" class="input mt-2" type="password" placeholder="********" autocomplete="current-password" />
        </div>

        <button id="login-btn" class="btn btn-primary w-full mt-2">Entrar</button>
        <p id="login-error" class="text-sm mt-2 hidden" style="color:#ef4444;">Email ou senha invÃ¡lidos.</p>
      </div>
    </div>
  </div>

  <div id="app" class="min-h-screen hidden">
    <header class="sticky top-0 z-50 backdrop-blur bg-black/70 border-b border-neutral-800">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-3">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold title" style="color:#fde68a;">Painel do Restaurante</h1>
            <p class="text-sm muted">Pedidos e Produtos (Firebase)</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="btn-refresh" class="btn btn-dark">ğŸ”„ Atualizar</button>
            <button id="btn-logout" class="btn btn-red">Sair</button>
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <button id="tab-orders" class="tab-btn active">ğŸ§¾ Pedidos</button>
          <button id="tab-products" class="tab-btn">ğŸ” Produtos</button>
          <button id="tab-dashboard" class="tab-btn">ğŸ“Š Dashboard</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
      <!-- PEDIDOS -->
      <section id="view-orders" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <section class="lg:col-span-8 space-y-6">
          <div class="card p-5">
            <div class="flex flex-col md:flex-row md:items-end gap-4">
              <div class="flex-1">
                <label class="text-sm font-semibold" style="color:#fde68a;">Buscar (nome / telefone / item)</label>
                <input id="search" class="input mt-2" placeholder="Ex: JoÃ£o, 1199..., Smash..." />
              </div>
              <div class="w-full md:w-56">
                <label class="text-sm font-semibold" style="color:#fde68a;">Status</label>
                <select id="filter-status" class="input mt-2">
                  <option value="all">Todos</option>
                  <option value="new">Novo</option>
                  <option value="preparing">Preparando</option>
                  <option value="out_for_delivery">Saiu p/ entrega</option>
                  <option value="done">Feito</option>
                  <option value="cancelled">Cancelado</option>
                </select>
              </div>
            </div>
          </div>

          <div class="card p-5">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Fila de Pedidos</h2>
              <span id="orders-count" class="badge badge-new">ğŸ§¾ 0 pedido(s)</span>
            </div>

            <div id="orders-empty" class="mt-6 p-6 rounded-xl bg-neutral-950 border border-neutral-800 text-center hidden">
              <p class="text-lg font-bold" style="color:#fde68a;">Nenhum pedido ainda</p>
              <p class="text-sm muted mt-1">Quando o cliente enviar, ele aparece aqui.</p>
            </div>

            <div id="orders-list" class="mt-5 space-y-4"></div>
          </div>
        </section>

        <section class="lg:col-span-4 space-y-6">
          <div class="card p-5">
            <h2 class="text-xl font-bold title" style="color:#fde68a;">AÃ§Ãµes rÃ¡pidas</h2>
            <p class="text-sm muted mt-2">Clique em â€œAbrir WhatsAppâ€ em um pedido para responder rÃ¡pido.</p>
            <div class="divider my-5"></div>
            <p class="text-xs muted">Obs.: WhatsApp API oficial exige backend/token. Aqui abrimos WhatsApp Web/App com mensagem pronta.</p>
          </div>
        </section>
      </section>

      <!-- PRODUTOS -->
      <section id="view-products" class="hidden space-y-6">
        <div class="card p-5">
          <div class="flex flex-col md:flex-row md:items-end gap-4">
            <div class="flex-1">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Produtos (Editar / Excluir / Adicionar)</h2>
              <p class="text-sm muted mt-1">Edita a coleÃ§Ã£o <b>products</b>. Isso aparece no cardÃ¡pio do cliente (index).</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="btn-new-product" class="btn btn-primary">â• Novo produto</button>
            </div>
          </div>
        </div>

        <div class="card p-5">
          <div class="flex flex-col md:flex-row md:items-end gap-4">
            <div class="flex-1">
              <label class="text-sm font-semibold" style="color:#fde68a;">Buscar produto</label>
              <input id="product-search" class="input mt-2" placeholder="Ex: burger, pepperoni, suco..." />
            </div>

            <div class="w-full md:w-56">
              <label class="text-sm font-semibold" style="color:#fde68a;">Categoria</label>
              <select id="product-category-filter" class="input mt-2">
                <option value="all">Todas</option>
                <option value="Lanches">Lanches</option>
                <option value="Pizzas">Pizzas</option>
                <option value="Pratos Principais">Pratos Principais</option>
                <option value="Bebidas">Bebidas</option>
                <option value="Sobremesas">Sobremesas</option>
              </select>
            </div>
          </div>

          <div class="divider my-5"></div>

          <div id="products-empty" class="mt-2 p-6 rounded-xl bg-neutral-950 border border-neutral-800 text-center hidden">
            <p class="text-lg font-bold" style="color:#fde68a;">Nenhum produto cadastrado</p>
            <p class="text-sm muted mt-1">Clique em â€œNovo produtoâ€ para comeÃ§ar.</p>
          </div>

          <div id="products-list" class="mt-2 space-y-3"></div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="view-dashboard" class="hidden space-y-6">
        <div class="card p-5">
          <h2 class="text-xl font-bold title" style="color:#fde68a;">Dashboard</h2>
          <p class="text-sm muted mt-1">MÃ©tricas baseadas nos pedidos carregados.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="card p-5"><p class="text-xs muted">ğŸ†• Novos</p><p id="m-new" class="text-3xl font-black" style="color:#fde68a;">0</p></div>
          <div class="card p-5"><p class="text-xs muted">ğŸ‘¨â€ğŸ³ Preparando</p><p id="m-prep" class="text-3xl font-black" style="color:#bfdbfe;">0</p></div>
          <div class="card p-5"><p class="text-xs muted">ğŸšš Saiu</p><p id="m-out" class="text-3xl font-black" style="color:#bbf7d0;">0</p></div>
          <div class="card p-5"><p class="text-xs muted">âœ… Feitos</p><p id="m-done" class="text-3xl font-black" style="color:#e9d5ff;">0</p></div>
          <div class="card p-5"><p class="text-xs muted">â›” Cancelados</p><p id="m-cancel" class="text-3xl font-black" style="color:#fecaca;">0</p></div>
          <div class="card p-5 lg:col-span-3">
            <p class="text-xs muted">ğŸ’° Faturamento (Feitos)</p>
            <p id="m-revenue" class="text-3xl font-black" style="color:#d97706;">R$ 0,00</p>
            <p class="text-xs muted mt-2">Soma apenas pedidos com status <b>done</b>.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL PRODUTO -->
  <div id="product-modal" class="modal-overlay">
    <div class="card w-full max-w-2xl p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 id="product-modal-title" class="text-2xl font-extrabold title" style="color:#fde68a;">Produto</h3>
          <p class="text-sm muted mt-1">Salvar = grava no Firestore.</p>
        </div>
        <button id="product-modal-close" class="btn btn-dark">âœ–</button>
      </div>

      <div class="divider my-5"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Nome</label>
          <input id="p-name" class="input mt-2" placeholder="Ex: Smash Burger Especial" />
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Categoria</label>
          <select id="p-category" class="input mt-2">
            <option value="Lanches">Lanches</option>
            <option value="Pizzas">Pizzas</option>
            <option value="Pratos Principais">Pratos Principais</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Sobremesas">Sobremesas</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">PreÃ§o</label>
          <input id="p-price" class="input mt-2" type="number" step="0.01" placeholder="Ex: 32.90" />
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Emoji (opcional)</label>
          <input id="p-emoji" class="input mt-2" placeholder="Ex: ğŸ”" />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">DescriÃ§Ã£o</label>
          <textarea id="p-desc" class="input mt-2" rows="3" placeholder="Descreva o produto..."></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-semibold" style="color:#fde68a;">URL da Foto (opcional)</label>
          <input id="p-image" class="input mt-2" placeholder="https://..." />
        </div>
      </div>

      <div class="divider my-5"></div>

      <div class="flex flex-col md:flex-row gap-2 md:justify-between">
        <button id="btn-delete-product" class="btn btn-red hidden">ğŸ—‘ï¸ Excluir produto</button>
        <div class="flex gap-2 md:justify-end">
          <button id="btn-cancel-product" class="btn btn-dark">Cancelar</button>
          <button id="btn-save-product" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      doc, updateDoc, serverTimestamp, addDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqFZJ5wg3VIJlJtA4DgFS499_9rXu-zAk",
      authDomain: "cardapio-digital-adc3d.firebaseapp.com",
      projectId: "cardapio-digital-adc3d",
      storageBucket: "cardapio-digital-adc3d.firebasestorage.app",
      messagingSenderId: "762370492160",
      appId: "1:762370492160:web:86a86687c52a76f56895e5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    function moneyBR(value){
      const n = Number(value || 0);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }
    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // Tabs
    function setTab(tab){
      ["orders","products","dashboard"].forEach(t=>{
        $("tab-"+t).classList.toggle("active", t===tab);
        $("view-"+t).classList.toggle("hidden", t!==tab);
      });
    }
    $("tab-orders").addEventListener("click", ()=>setTab("orders"));
    $("tab-products").addEventListener("click", ()=>setTab("products"));
    $("tab-dashboard").addEventListener("click", ()=>setTab("dashboard"));

    // Auth
    async function doLogin(){
      $("login-error").classList.add("hidden");
      const email = ($("login-email").value || "").trim();
      const pass  = ($("login-pass").value || "").trim();
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch { $("login-error").classList.remove("hidden"); }
    }
    $("login-btn").addEventListener("click", doLogin);
    $("login-pass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    $("btn-logout").addEventListener("click", async ()=>{ await signOut(auth); });

    // Pedidos (igual)
    function statusBadge(status){
      if(status === "new") return `<span class="badge badge-new">ğŸ†• Novo</span>`;
      if(status === "preparing") return `<span class="badge badge-prep">ğŸ‘¨â€ğŸ³ Preparando</span>`;
      if(status === "out_for_delivery") return `<span class="badge badge-out">ğŸšš Saiu</span>`;
      if(status === "done") return `<span class="badge badge-done">âœ… Feito</span>`;
      if(status === "cancelled") return `<span class="badge badge-cancel">â›” Cancelado</span>`;
      return `<span class="badge badge-new">ğŸ†• Novo</span>`;
    }
    function normalizePhoneBR(phone){
      const digits = String(phone || "").replace(/\D/g, "");
      if(!digits) return "";
      if(digits.startsWith("55")) return digits;
      return "55" + digits;
    }
    function buildWhatsAppLink(order){
      const items = (order.items||[])
        .map(i => `- ${i.qty}x ${i.name} (${moneyBR((i.price||0) * (i.qty||0))})`)
        .join("\n");

      const text =
`âœ… Pedido recebido!
Cliente: ${order.customer?.name || ""}
Telefone: ${order.customer?.phone || ""}
EndereÃ§o: ${order.customer?.addressLine || ""}

Itens:
${items}

Total: ${moneyBR(order.total || 0)}

Responda aqui para confirmar.`;

      const phone = normalizePhoneBR(order.customer?.phone || "");
      return phone
        ? `https://wa.me/${phone}?text=${encodeURIComponent(text)}`
        : `https://wa.me/?text=${encodeURIComponent(text)}`;
    }

    let unsubOrders = null;
    let liveOrders = [];

    function applyFilters(orders){
      const q = ($("search").value || "").toLowerCase().trim();
      const st = $("filter-status").value;
      let list = [...orders];
      if(st !== "all") list = list.filter(o => o.status === st);
      if(q){
        list = list.filter(o => {
          const itemsText = (o.items || []).map(i => i.name).join(" ");
          return (
            (o.customer?.name || "").toLowerCase().includes(q) ||
            (o.customer?.phone || "").toLowerCase().includes(q) ||
            itemsText.toLowerCase().includes(q)
          );
        });
      }
      return list;
    }

    async function setOrderStatus(orderId, status){
      await updateDoc(doc(db, "orders", orderId), { status, updatedAt: serverTimestamp() });
    }

    function renderDashboard(){
      const c = { new:0, preparing:0, out_for_delivery:0, done:0, cancelled:0 };
      let revenue = 0;
      liveOrders.forEach(o=>{
        const st = o.status || "new";
        if(c[st] !== undefined) c[st]++;
        if(st === "done") revenue += Number(o.total || 0);
      });
      $("m-new").textContent = c.new;
      $("m-prep").textContent = c.preparing;
      $("m-out").textContent = c.out_for_delivery;
      $("m-done").textContent = c.done;
      $("m-cancel").textContent = c.cancelled;
      $("m-revenue").textContent = moneyBR(revenue);
    }

    function renderOrders(){
      const list = applyFilters(liveOrders);
      $("orders-count").textContent = `ğŸ§¾ ${list.length} pedido(s)`;
      $("orders-empty").classList.toggle("hidden", list.length !== 0);

      $("orders-list").innerHTML = list.map(o => {
        let createdDate = new Date();
        if (o.createdAt?.toDate) createdDate = o.createdAt.toDate();
        else if (typeof o.createdAt === "string") createdDate = new Date(o.createdAt);
        const time = createdDate.toLocaleString("pt-BR");

        const itemsHtml = (o.items || []).map(i =>
          `<li class="flex justify-between gap-3">
            <span class="text-sm" style="color:#fef3c7;">${Number(i.qty||0)}x ${escapeHtml(i.name)}</span>
            <span class="text-sm font-bold" style="color:#d97706;">${moneyBR((i.price||0) * (i.qty||0))}</span>
          </li>`
        ).join("");

        const waLink = buildWhatsAppLink(o);
        const shortId = (o.id || "").slice(-6).toUpperCase() || "------";

        return `
          <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
              <div>
                <div class="flex items-center gap-2 flex-wrap">
                  <p class="font-extrabold" style="color:#fde68a;">Pedido #${escapeHtml(shortId)}</p>
                  ${statusBadge(o.status)}
                </div>
                <p class="text-sm muted mt-1">${time}</p>

                <div class="mt-3 text-sm">
                  <p style="color:#fef3c7;"><span class="muted">Cliente:</span> <b>${escapeHtml(o.customer?.name || "â€”")}</b></p>
                  <p style="color:#fef3c7;"><span class="muted">Telefone:</span> <b>${escapeHtml(o.customer?.phone || "â€”")}</b></p>
                  <p class="mt-2 muted">EndereÃ§o:</p>
                  <p style="color:#fef3c7;">${escapeHtml(o.customer?.addressLine || "â€”")}</p>
                </div>
              </div>

              <div class="min-w-[240px]">
                <div class="p-3 rounded-xl bg-black border border-neutral-800">
                  <p class="text-xs muted">Total</p>
                  <p class="text-2xl font-extrabold" style="color:#d97706;">${moneyBR(o.total || 0)}</p>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-3">
                  <button class="btn btn-dark" data-act="prep" data-id="${o.id}">ğŸ‘¨â€ğŸ³ Preparando</button>
                  <button class="btn btn-blue" data-act="out" data-id="${o.id}">ğŸšš Saiu</button>
                  <button class="btn btn-green" data-act="done" data-id="${o.id}">âœ… Feito</button>
                  <button class="btn btn-red" data-act="cancel" data-id="${o.id}">â›” Cancelar</button>
                </div>

                <a class="btn btn-dark w-full mt-2 block text-center" href="${waLink}" target="_blank" rel="noopener">ğŸ’¬ Abrir WhatsApp</a>
              </div>
            </div>

            <div class="divider my-4"></div>

            <div>
              <p class="text-sm font-bold" style="color:#fde68a;">Itens</p>
              <ul class="mt-2 space-y-2">${itemsHtml}</ul>
            </div>
          </div>
        `;
      }).join("");

      $("orders-list").querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          const map = { prep:"preparing", out:"out_for_delivery", done:"done", cancel:"cancelled" };
          await setOrderStatus(id, map[act] || "new");
        });
      });

      renderDashboard();
    }

    function startOrdersRealtime(){
      if(unsubOrders) unsubOrders();
      const qy = query(collection(db, "orders"), orderBy("createdAt", "desc"));
      unsubOrders = onSnapshot(qy, (snap) => {
        liveOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderOrders();
      });
    }

    $("search").addEventListener("input", ()=>renderOrders());
    $("filter-status").addEventListener("change", ()=>renderOrders());

    // Produtos CRUD
    let unsubProducts = null;
    let liveProducts = [];
    let editingProductId = null;

    function productMatchesFilters(p){
      const q = ($("product-search").value || "").toLowerCase().trim();
      const cat = $("product-category-filter").value;
      if(cat !== "all" && (p.category || "") !== cat) return false;
      if(!q) return true;
      const text = `${p.name||""} ${p.description||""} ${p.category||""}`.toLowerCase();
      return text.includes(q);
    }

    function renderProducts(){
      $("products-empty").classList.toggle("hidden", liveProducts.length !== 0);

      const list = liveProducts.filter(productMatchesFilters);

      $("products-list").innerHTML = list.map(p=>{
        const img = p.imageUrl ? `<img src="${escapeHtml(p.imageUrl)}" alt="Foto">` : `<span>SEM FOTO</span>`;
        const emoji = p.emoji ? escapeHtml(p.emoji) + " " : "";
        return `
          <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800 flex flex-col md:flex-row gap-4 md:items-center">
            <div class="imgbox">${img}</div>

            <div class="flex-1">
              <p class="text-xs muted">${escapeHtml(p.category || "â€”")}</p>
              <p class="text-lg font-black" style="color:#fde68a;">${emoji}${escapeHtml(p.name || "Sem nome")}</p>
              <p class="text-sm muted mt-1">${escapeHtml(p.description || "")}</p>
            </div>

            <div class="flex flex-col md:items-end gap-2">
              <p class="text-xl font-black" style="color:#d97706;">${moneyBR(p.price || 0)}</p>
              <div class="flex gap-2">
                <button class="btn btn-dark" data-edit="${p.id}">âœï¸ Editar</button>
                <button class="btn btn-red" data-del="${p.id}">ğŸ—‘ï¸ Excluir</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      $("products-list").querySelectorAll("button[data-edit]").forEach(b=>{
        b.addEventListener("click", ()=>openEditProduct(b.getAttribute("data-edit")));
      });
      $("products-list").querySelectorAll("button[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>confirmDeleteProduct(b.getAttribute("data-del")));
      });
    }

    function startProductsRealtime(){
      if(unsubProducts) unsubProducts();
      const qy = query(collection(db, "products"), orderBy("category", "asc"), orderBy("name", "asc"));
      unsubProducts = onSnapshot(qy, (snap)=>{
        liveProducts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderProducts();
      });
    }

    $("product-search").addEventListener("input", ()=>renderProducts());
    $("product-category-filter").addEventListener("change", ()=>renderProducts());

    // Modal
    function openProductModal(mode){
      $("product-modal").classList.add("active");
      $("product-modal-title").textContent = mode === "new" ? "â• Novo Produto" : "âœï¸ Editar Produto";
      $("btn-delete-product").classList.toggle("hidden", mode === "new");
    }
    function closeProductModal(){
      $("product-modal").classList.remove("active");
      editingProductId = null;
      $("p-name").value = "";
      $("p-desc").value = "";
      $("p-price").value = "";
      $("p-category").value = "Lanches";
      $("p-emoji").value = "";
      $("p-image").value = "";
    }
    $("product-modal-close").addEventListener("click", closeProductModal);
    $("btn-cancel-product").addEventListener("click", closeProductModal);

    $("btn-new-product").addEventListener("click", ()=>{
      editingProductId = null;
      openProductModal("new");
    });

    function openEditProduct(id){
      const p = liveProducts.find(x=>x.id === id);
      if(!p) return;
      editingProductId = id;
      $("p-name").value = p.name || "";
      $("p-desc").value = p.description || "";
      $("p-price").value = String(p.price ?? "");
      $("p-category").value = p.category || "Lanches";
      $("p-emoji").value = p.emoji || "";
      $("p-image").value = p.imageUrl || "";
      openProductModal("edit");
    }

    async function confirmDeleteProduct(id){
      const p = liveProducts.find(x=>x.id === id);
      const ok = confirm(`Excluir o produto: "${p?.name || id}"?`);
      if(!ok) return;
      await deleteDoc(doc(db, "products", id));
    }

    $("btn-delete-product").addEventListener("click", async ()=>{
      if(!editingProductId) return;
      const ok = confirm("Excluir este produto?");
      if(!ok) return;
      await deleteDoc(doc(db, "products", editingProductId));
      closeProductModal();
    });

    $("btn-save-product").addEventListener("click", async ()=>{
      const name = ($("p-name").value || "").trim();
      const description = ($("p-desc").value || "").trim();
      const category = ($("p-category").value || "Lanches").trim();
      const emoji = ($("p-emoji").value || "").trim();
      const imageUrl = ($("p-image").value || "").trim();
      const price = Number(String($("p-price").value || "").replace(",", "."));

      if(!name || !Number.isFinite(price)){
        alert("Preencha Nome e PreÃ§o corretamente.");
        return;
      }

      const payload = { name, description, category, emoji, imageUrl, price, updatedAt: serverTimestamp(), isActive: true };

      if(editingProductId){
        await updateDoc(doc(db, "products", editingProductId), payload);
      } else {
        await addDoc(collection(db, "products"), { ...payload, createdAt: serverTimestamp() });
      }

      closeProductModal();
    });

    // Refresh
    $("btn-refresh").addEventListener("click", ()=>{
      renderOrders();
      renderProducts();
      renderDashboard();
    });

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if(user){
        $("login-overlay").classList.add("hidden");
        $("app").classList.remove("hidden");
        setTab("orders");
        startOrdersRealtime();
        startProductsRealtime();
      } else {
        $("app").classList.add("hidden");
        $("login-overlay").classList.remove("hidden");
        if(unsubOrders) unsubOrders();
        if(unsubProducts) unsubProducts();
        unsubOrders = null; unsubProducts = null;
        liveOrders = []; liveProducts = [];
        $("orders-list").innerHTML = "";
        $("products-list").innerHTML = "";
        $("orders-count").textContent = "ğŸ§¾ 0 pedido(s)";
      }
    });
  </script>
</body>
</html>
