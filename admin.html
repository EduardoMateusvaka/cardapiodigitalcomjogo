<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Restaurante (Admin)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; }
    * { scrollbar-width: thin; scrollbar-color: #d97706 #0b0b0b; }
    .card { background: linear-gradient(135deg,#1c1c1c 0%, #141414 100%); border: 1px solid #2c2c2c; border-radius: 18px; }
    .btn { border-radius: 14px; padding: 10px 12px; font-weight: 800; }
    .btn-primary { background: linear-gradient(135deg,#d97706 0%,#b45309 100%); color:#141414; }
    .btn-dark { background:#0f0f0f; border:1px solid #2c2c2c; color:#fde68a; }
    .btn-red { background: linear-gradient(135deg,#ef4444 0%,#b91c1c 100%); color:#170505; }
    .badge { border-radius: 999px; padding: 6px 10px; font-weight: 800; font-size: 12px; display:inline-flex; align-items:center; gap:6px; }
    .badge-new { background: rgba(217,119,6,.18); border:1px solid rgba(217,119,6,.35); color:#fde68a; }
    .title { font-family:'Playfair Display', serif; }
    .input { width:100%; background:#0f0f0f; border:1px solid #2c2c2c; border-radius: 14px; padding: 12px 14px; color:#fef3c7; }
    .muted { color:#a3a3a3; }
    .divider { border-top: 1px solid #2c2c2c; }
    .tab { padding: 10px 12px; border-radius: 14px; font-weight: 800; border:1px solid #2c2c2c; background:#0f0f0f; color:#fde68a; }
    .tab.active { background: linear-gradient(135deg,#d97706 0%,#b45309 100%); color:#141414; border-color: transparent; }
  </style>
</head>

<body class="h-full bg-black text-white">

  <!-- LOGIN OVERLAY -->
  <div id="login-overlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 p-4">
    <div class="card w-full max-w-md p-6">
      <h2 class="text-2xl font-extrabold title" style="color:#fde68a;">üîí Painel do Restaurante</h2>
      <p class="text-sm muted mt-1">Entre ou crie sua conta (cada restaurante tem seu pr√≥prio painel).</p>

      <div class="grid grid-cols-2 gap-2 mt-4">
        <button id="mode-login" class="btn btn-primary w-full">Entrar</button>
        <button id="mode-register" class="btn btn-dark w-full">Criar conta</button>
      </div>

      <div class="mt-5 space-y-3">
        <div id="register-extra" class="hidden space-y-3">
          <div>
            <label class="text-sm font-semibold" style="color:#fde68a;">Nome do Restaurante</label>
            <input id="reg-rest-name" class="input mt-2" type="text" placeholder="Ex: Sabor & Arte" />
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">Nome do propriet√°rio</label>
              <input id="reg-owner-name" class="input mt-2" type="text" placeholder="Ex: Jo√£o Silva" />
            </div>
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">CPF</label>
              <input id="reg-owner-cpf" class="input mt-2" type="text" placeholder="000.000.000-00" />
            </div>
          </div>

          <div>
            <label class="text-sm font-semibold" style="color:#fde68a;">Telefone (WhatsApp)</label>
            <input id="reg-phone" class="input mt-2" type="tel" placeholder="(11) 99999-9999" />
          </div>

          <p class="text-xs muted">
            Ao criar, vamos gerar um ID √∫nico do restaurante e salvar no Firebase.
          </p>
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Email</label>
          <input id="login-email" class="input mt-2" type="email" placeholder="restaurante@email.com" autocomplete="username" />
        </div>

        <div>
          <label class="text-sm font-semibold" style="color:#fde68a;">Senha</label>
          <input id="login-pass" class="input mt-2" type="password" placeholder="********" autocomplete="current-password" />
        </div>

        <button id="submit-auth" class="btn btn-primary w-full mt-2">Entrar</button>

        <p id="login-error" class="text-sm mt-2 hidden" style="color:#ef4444;">Email ou senha inv√°lidos.</p>
        <p id="register-error" class="text-sm mt-2 hidden" style="color:#ef4444;">Erro ao criar conta.</p>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="min-h-screen hidden">
    <!-- Topbar -->
    <header class="sticky top-0 z-50 backdrop-blur bg-black/70 border-b border-neutral-800">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col gap-3">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold title" style="color:#fde68a;">Painel do Restaurante</h1>
            <p id="rest-indicator" class="text-sm muted">Carregando restaurante‚Ä¶</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="btn-logout" class="btn btn-red">Sair</button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap gap-2">
          <button id="tab-products" class="tab active">üçî Produtos</button>
          <button id="tab-orders" class="tab">üì¶ Pedidos</button>
          <button id="tab-categories" class="tab">üìù Categorias</button>
          <button id="tab-settings" class="tab">‚öôÔ∏è Dados do Restaurante</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

      <!-- LINK DE DIVULGA√á√ÉO -->
      <section class="card p-5 max-w-3xl">
        <h2 class="text-xl font-bold title" style="color:#fde68a;">üîó Link de Divulga√ß√£o</h2>
        <p class="text-sm muted mt-2">Envie este link para seus clientes acessarem o card√°pio do seu restaurante.</p>

        <div class="divider my-5"></div>

        <label class="text-sm font-semibold" style="color:#fde68a;">Esse √© seu link de divulga√ß√£o:</label>

        <div class="mt-2 flex flex-col md:flex-row gap-2">
          <input id="share-link" class="input flex-1" readonly value="Carregando..." />
          <button id="btn-copy-link" class="btn btn-primary">üìã Copiar</button>
          <a id="btn-open-link" class="btn btn-dark text-center" target="_blank" rel="noopener">üîé Abrir</a>
        </div>

        <p class="text-xs muted mt-3">Dica: coloque esse link no Instagram, WhatsApp e Google.</p>
      </section>

      <!-- PRODUCTS VIEW -->
      <section id="view-products">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <div class="lg:col-span-4 space-y-6">
            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Gerenciar Produtos</h2>
              <p class="text-sm muted mt-2">Cole√ß√£o: <b>restaurants/{id}/products</b></p>

              <div class="divider my-5"></div>

              <button id="btn-add-product" class="btn btn-primary w-full">‚ûï Adicionar Produto</button>

              <div class="divider my-5"></div>

              <label class="text-sm font-semibold" style="color:#fde68a;">Buscar produto</label>
              <input id="prod-search" class="input mt-2" placeholder="Ex: Pizza, Smash, Coca..." />
              <p id="products-error" class="text-xs mt-3 hidden" style="color:#ef4444;"></p>
            </div>
          </div>

          <div class="lg:col-span-8 space-y-6">
            <div class="card p-5">
              <div class="flex items-center justify-between gap-3">
                <h2 class="text-xl font-bold title" style="color:#fde68a;">Lista de Produtos</h2>
                <span id="products-count" class="badge badge-new">üçî 0</span>
              </div>

              <div id="products-empty" class="mt-6 p-6 rounded-xl bg-neutral-950 border border-neutral-800 text-center hidden">
                <p class="text-lg font-bold" style="color:#fde68a;">Nenhum produto salvo</p>
                <p class="text-sm muted mt-1">Clique em ‚ÄúAdicionar Produto‚Äù.</p>
              </div>

              <div id="products-list" class="mt-5 space-y-4"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ORDERS VIEW -->
      <section id="view-orders" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <div class="lg:col-span-4 space-y-6">
            <div class="card p-5">
              <h2 class="text-xl font-bold title" style="color:#fde68a;">Pedidos em tempo real</h2>
              <p class="text-sm muted mt-2">Cole√ß√£o: <b>restaurants/{id}/orders</b></p>
              <div class="divider my-5"></div>

              <label class="text-sm font-semibold" style="color:#fde68a;">Filtrar status</label>
              <select id="orders-filter" class="input mt-2">
                <option value="all">Todos</option>
                <option value="new">Novos</option>
                <option value="accepted">Aceitos</option>
                <option value="preparing">Preparando</option>
                <option value="ready">Pronto</option>
                <option value="delivered">Entregue</option>
                <option value="canceled">Cancelado</option>
              </select>

              <p id="orders-error" class="text-xs mt-3 hidden" style="color:#ef4444;"></p>
            </div>

            <div class="card p-5">
              <h3 class="text-lg font-bold title" style="color:#fde68a;">üìä Dashboard r√°pido</h3>
              <p class="text-sm muted mt-1">Baseado nos √∫ltimos 200 pedidos.</p>
              <div class="divider my-5"></div>

              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="muted">Pedidos</span>
                  <b id="dash-orders" style="color:#fde68a;">0</b>
                </div>
                <div class="flex justify-between">
                  <span class="muted">Faturamento</span>
                  <b id="dash-revenue" style="color:#fde68a;">R$ 0,00</b>
                </div>
              </div>

              <div class="divider my-5"></div>
              <p class="text-sm font-bold" style="color:#fde68a;">Mais vendidos</p>
              <div id="dash-top-items" class="mt-3 space-y-2 text-sm"></div>
            </div>
          </div>

          <div class="lg:col-span-8 space-y-6">
            <div class="card p-5">
              <div class="flex items-center justify-between gap-3">
                <h2 class="text-xl font-bold title" style="color:#fde68a;">Lista de Pedidos</h2>
                <span id="orders-count" class="badge badge-new">üì¶ 0</span>
              </div>

              <div id="orders-empty" class="mt-6 p-6 rounded-xl bg-neutral-950 border border-neutral-800 text-center hidden">
                <p class="text-lg font-bold" style="color:#fde68a;">Nenhum pedido ainda</p>
                <p class="text-sm muted mt-1">Quando algu√©m pedir, aparece aqui.</p>
              </div>

              <div id="orders-list" class="mt-5 space-y-4"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CATEGORIES VIEW -->
      <section id="view-categories" class="hidden">
        <div class="card p-5 max-w-2xl">
          <h2 class="text-xl font-bold title" style="color:#fde68a;">Renomear Categorias (t√≠tulos)</h2>
          <p class="text-sm muted mt-2">Documento: <b>restaurants/{id}/settings/menu</b></p>

          <div class="divider my-5"></div>

          <div class="space-y-3">
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">Lanches</label>
              <input id="cat-title-Lanches" class="input mt-2" />
            </div>
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">Pizzas</label>
              <input id="cat-title-Pizzas" class="input mt-2" />
            </div>
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">Bebidas</label>
              <input id="cat-title-Bebidas" class="input mt-2" />
            </div>
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">Sobremesas</label>
              <input id="cat-title-Sobremesas" class="input mt-2" />
            </div>
          </div>

          <div class="divider my-5"></div>

          <div class="flex gap-2">
            <button id="btn-cat-save" class="btn btn-primary w-full">üíæ Salvar</button>
            <button id="btn-cat-reset" class="btn btn-dark">‚Ü©Ô∏è Reset</button>
          </div>

          <p id="cat-msg" class="text-sm mt-3 hidden"></p>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="hidden">
        <div class="card p-5 max-w-2xl">
          <h2 class="text-xl font-bold title" style="color:#fde68a;">Dados do Restaurante</h2>
          <p class="text-sm muted mt-2">Documento: <b>restaurants/{id}</b></p>

          <div class="divider my-5"></div>

          <div class="space-y-3">
            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">Nome do restaurante</label>
              <input id="set-rest-name" class="input mt-2" placeholder="Ex: Sabor & Arte" />
            </div>

            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">URL da logo (c√≠rculo do topo)</label>
              <input id="set-logo-url" class="input mt-2" placeholder="https://..." />
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-sm font-semibold" style="color:#fde68a;">Dias</label>
                <input id="set-days" class="input mt-2" placeholder="Seg a Dom" />
              </div>
              <div>
                <label class="text-sm font-semibold" style="color:#fde68a;">Hor√°rio</label>
                <input id="set-hours" class="input mt-2" placeholder="11h √†s 23h" />
              </div>
            </div>

            <div>
              <label class="text-sm font-semibold" style="color:#fde68a;">WhatsApp do restaurante (somente n√∫meros)</label>
              <input id="set-whatsapp" class="input mt-2" placeholder="5511999999999" />
              <p class="text-xs muted mt-2">Esse n√∫mero √© o que o index usa pra abrir o WhatsApp com a mensagem do pedido.</p>
            </div>
          </div>

          <div class="divider my-5"></div>

          <button id="btn-settings-save" class="btn btn-primary w-full">üíæ Salvar dados</button>
          <p id="settings-msg" class="text-sm mt-3 hidden"></p>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      getDoc,
      updateDoc,
      serverTimestamp,
      addDoc,
      deleteDoc,
      setDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqFZJ5wg3VIJlJtA4DgFS499_9rXu-zAk",
      authDomain: "cardapio-digital-adc3d.firebaseapp.com",
      projectId: "cardapio-digital-adc3d",
      storageBucket: "cardapio-digital-adc3d.firebasestorage.app",
      messagingSenderId: "762370492160",
      appId: "1:762370492160:web:86a86687c52a76f56895e5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    function digits(v){ return String(v || "").replace(/\D/g, ""); }

    // =======================
    // UI Auth Mode
    // =======================
    let AUTH_MODE = "login";
    function setMode(mode){
      AUTH_MODE = mode;
      const isReg = AUTH_MODE === "register";
      $("register-extra").classList.toggle("hidden", !isReg);
      $("mode-login").classList.toggle("btn-primary", !isReg);
      $("mode-login").classList.toggle("btn-dark", isReg);
      $("mode-register").classList.toggle("btn-primary", isReg);
      $("mode-register").classList.toggle("btn-dark", !isReg);
      $("submit-auth").textContent = isReg ? "Criar conta" : "Entrar";
      $("login-error").classList.add("hidden");
      $("register-error").classList.add("hidden");
    }
    $("mode-login").onclick = () => setMode("login");
    $("mode-register").onclick = () => setMode("register");
    setMode("login");

    function randomId(prefix="rest_"){
      return prefix + Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,6);
    }

    // =======================
    // SaaS: cria estrutura do restaurante + user profile
    // =======================
    async function createSaasRestaurantForUser(user, regData){
      const restaurantId = randomId();

      const restRef = doc(db, "restaurants", restaurantId);
      const memberRef = doc(db, "restaurants", restaurantId, "members", user.uid);
      const menuRef = doc(db, "restaurants", restaurantId, "settings", "menu");
      const userRef = doc(db, "users", user.uid);

      await setDoc(restRef, {
        name: regData.restaurantName || "Meu Restaurante",
        logoUrl: "",
        hoursText: "11h √†s 23h",
        daysText: "Seg a Dom",
        whatsappPhone: digits(regData.phone || ""),
        ownerUid: user.uid,
        ownerName: regData.ownerName || "",
        ownerCpf: regData.ownerCpf || "",
        ownerPhone: digits(regData.phone || ""),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      await setDoc(memberRef, { role: "owner", createdAt: serverTimestamp() });

      await setDoc(menuRef, {
        categoryTitles: { Lanches:"Lanches", Pizzas:"Pizzas", Bebidas:"Bebidas", Sobremesas:"Sobremesas" },
        updatedAt: serverTimestamp()
      }, { merge: true });

      await setDoc(userRef, {
        restaurantId,
        role: "owner",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });

      return restaurantId;
    }

    async function doAuth(){
      $("login-error").classList.add("hidden");
      $("register-error").classList.add("hidden");

      const email = ($("login-email").value || "").trim();
      const pass = ($("login-pass").value || "").trim();

      try {
        if(AUTH_MODE === "login"){
          await signInWithEmailAndPassword(auth, email, pass);
          return;
        }

        const regData = {
          restaurantName: ($("reg-rest-name").value || "").trim(),
          ownerName: ($("reg-owner-name").value || "").trim(),
          ownerCpf: ($("reg-owner-cpf").value || "").trim(),
          phone: ($("reg-phone").value || "").trim()
        };

        if(!regData.restaurantName || !regData.ownerName || !regData.ownerCpf || !regData.phone){
          $("register-error").textContent = "Preencha: restaurante, propriet√°rio, CPF e telefone.";
          $("register-error").classList.remove("hidden");
          return;
        }

        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const restaurantId = await createSaasRestaurantForUser(cred.user, regData);

        alert(`‚úÖ Conta criada!\n\nSeu card√°pio:\nindex.html?r=${restaurantId}\n\n(Guarde esse link)`);
      } catch (e) {
        if (String(e?.code || "").includes("auth/email-already-in-use")) {
          $("register-error").textContent = "Esse email j√° est√° cadastrado. Clique em ENTRAR e fa√ßa login.";
          $("register-error").classList.remove("hidden");
          return;
        }

        if(AUTH_MODE === "login"){
          $("login-error").classList.remove("hidden");
        } else {
          $("register-error").textContent = "Erro ao criar conta: " + (e?.message || "desconhecido");
          $("register-error").classList.remove("hidden");
        }
      }
    }

    $("submit-auth").addEventListener("click", doAuth);
    $("login-pass").addEventListener("keydown", (e) => { if(e.key === "Enter") doAuth(); });

    // =======================
    // Tabs
    // =======================
    function setTab(tab){
      const tabs = ["products","orders","categories","settings"];
      tabs.forEach(t => {
        $("tab-"+t).classList.toggle("active", t === tab);
        $("view-"+t).classList.toggle("hidden", t !== tab);
      });
    }
    $("tab-products").addEventListener("click", () => setTab("products"));
    $("tab-orders").addEventListener("click", () => setTab("orders"));
    $("tab-categories").addEventListener("click", () => setTab("categories"));
    $("tab-settings").addEventListener("click", () => setTab("settings"));

    // =======================
    // Restaurant context (pega do /users/{uid})
    // =======================
    let restaurantId = "";

    function restDoc(){ return doc(db, "restaurants", restaurantId); }
    function menuDoc(){ return doc(db, "restaurants", restaurantId, "settings", "menu"); }
    function productsCol(){ return collection(db, "restaurants", restaurantId, "products"); }
    function ordersCol(){ return collection(db, "restaurants", restaurantId, "orders"); }

    async function resolveRestaurantId(user){
      try{
        const us = await getDoc(doc(db, "users", user.uid));
        if (us.exists() && us.data()?.restaurantId) return String(us.data().restaurantId);
      }catch(e){}

      const saved = localStorage.getItem("restaurantId") || "";
      if (saved) return saved;

      const url = new URL(location.href);
      const r = (url.searchParams.get("r") || "").trim();
      if (r) return r;

      return "";
    }

    // =======================
    // Share link
    // =======================
    function buildShareLink(restaurantId){
      const base = location.origin; // ex: https://seusite.netlify.app
      return `${base}/index.html?r=${encodeURIComponent(restaurantId)}`;
    }

    function updateShareLinkUI(){
      const link = buildShareLink(restaurantId);
      const input = $("share-link");
      const btnCopy = $("btn-copy-link");
      const btnOpen = $("btn-open-link");

      if(input) input.value = link;
      if(btnOpen) btnOpen.href = link;

      if(btnCopy){
        btnCopy.onclick = async () => {
          try{
            await navigator.clipboard.writeText(link);
            btnCopy.textContent = "‚úÖ Copiado!";
            setTimeout(() => (btnCopy.textContent = "üìã Copiar"), 1200);
          }catch(e){
            if(input){
              input.focus();
              input.select();
              document.execCommand("copy");
              btnCopy.textContent = "‚úÖ Copiado!";
              setTimeout(() => (btnCopy.textContent = "üìã Copiar"), 1200);
            }
          }
        };
      }
    }

    // =======================
    // Settings
    // =======================
    function setSettingsMsg(text, ok=true){
      $("settings-msg").textContent = text;
      $("settings-msg").classList.remove("hidden");
      $("settings-msg").style.color = ok ? "#22c55e" : "#ef4444";
    }

    async function loadRestaurantSettings(){
      const snap = await getDoc(restDoc());
      const data = snap.exists() ? snap.data() : {};
      $("rest-indicator").textContent = `Restaurante: ${data.name || restaurantId}`;

      $("set-rest-name").value = data.name || "";
      $("set-logo-url").value = data.logoUrl || "";
      $("set-days").value = data.daysText || "";
      $("set-hours").value = data.hoursText || "";
      $("set-whatsapp").value = data.whatsappPhone || "";
      $("settings-msg").classList.add("hidden");
    }

    async function saveRestaurantSettings(){
      try{
        await setDoc(restDoc(), {
          name: ($("set-rest-name").value || "").trim(),
          logoUrl: ($("set-logo-url").value || "").trim(),
          daysText: ($("set-days").value || "").trim(),
          hoursText: ($("set-hours").value || "").trim(),
          whatsappPhone: digits(($("set-whatsapp").value || "").trim()),
          updatedAt: serverTimestamp()
        }, { merge: true });

        setSettingsMsg("‚úÖ Dados do restaurante salvos!", true);
        await loadRestaurantSettings();
      }catch(e){
        setSettingsMsg("Erro ao salvar dados do restaurante (verifique rules).", false);
      }
    }
    $("btn-settings-save").addEventListener("click", saveRestaurantSettings);

    // =======================
    // Categories titles
    // =======================
    function setCatMsg(text, ok=true){
      $("cat-msg").textContent = text;
      $("cat-msg").classList.remove("hidden");
      $("cat-msg").style.color = ok ? "#22c55e" : "#ef4444";
    }

    async function loadCategoryTitles(){
      try{
        const snap = await getDoc(menuDoc());
        const data = snap.exists() ? snap.data() : {};
        const titles = data.categoryTitles || {};

        $("cat-title-Lanches").value = titles.Lanches || "Lanches";
        $("cat-title-Pizzas").value = titles.Pizzas || "Pizzas";
        $("cat-title-Bebidas").value = titles.Bebidas || "Bebidas";
        $("cat-title-Sobremesas").value = titles.Sobremesas || "Sobremesas";

        $("cat-msg").classList.add("hidden");
      } catch (e){
        setCatMsg("Erro ao carregar t√≠tulos. Verifique rules.", false);
      }
    }

    async function saveCategoryTitles(){
      try{
        await setDoc(menuDoc(), {
          categoryTitles: {
            Lanches: ($("cat-title-Lanches").value || "Lanches").trim(),
            Pizzas: ($("cat-title-Pizzas").value || "Pizzas").trim(),
            Bebidas: ($("cat-title-Bebidas").value || "Bebidas").trim(),
            Sobremesas: ($("cat-title-Sobremesas").value || "Sobremesas").trim()
          },
          updatedAt: serverTimestamp()
        }, { merge: true });

        setCatMsg("‚úÖ T√≠tulos salvos!", true);
      } catch (e){
        setCatMsg("Erro ao salvar t√≠tulos. Verifique rules.", false);
      }
    }

    function resetCategoryTitles(){
      $("cat-title-Lanches").value = "Lanches";
      $("cat-title-Pizzas").value = "Pizzas";
      $("cat-title-Bebidas").value = "Bebidas";
      $("cat-title-Sobremesas").value = "Sobremesas";
      $("cat-msg").classList.add("hidden");
    }

    $("btn-cat-save").addEventListener("click", saveCategoryTitles);
    $("btn-cat-reset").addEventListener("click", resetCategoryTitles);

    // =======================
    // Products
    // =======================
    let unsubProducts = null;
    let liveProducts = [];

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function safeNumber(v){
      const n = Number(String(v ?? "").replace(",", "."));
      return isNaN(n) ? 0 : n;
    }

    function renderProducts(){
      const q = ($("prod-search")?.value || "").toLowerCase().trim();
      let list = [...liveProducts];

      if(q){
        list = list.filter(p =>
          (p.name||"").toLowerCase().includes(q) ||
          (p.category||"").toLowerCase().includes(q) ||
          (p.description||"").toLowerCase().includes(q)
        );
      }

      $("products-count").textContent = `üçî ${list.length}`;
      $("products-empty").classList.toggle("hidden", list.length !== 0);

      $("products-list").innerHTML = list.map(p => {
        const img = p.imageUrl
          ? `<img src="${escapeHtml(p.imageUrl)}" class="w-14 h-14 rounded-xl object-cover border border-neutral-800" />`
          : `<div class="w-14 h-14 rounded-xl bg-neutral-950 border border-neutral-800 flex items-center justify-center text-xl">üñºÔ∏è</div>`;

        return `
          <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800" data-prod="${p.id}">
            <div class="flex items-start gap-3">
              ${img}

              <div class="flex-1 space-y-2">
                <div class="grid grid-cols-1 gap-2">
                  <input class="input" data-f="name" value="${escapeHtml(p.name||"")}" placeholder="Nome do produto" />
                  <textarea class="input" data-f="description" rows="2" placeholder="Descri√ß√£o">${escapeHtml(p.description||"")}</textarea>

                  <div class="grid grid-cols-2 gap-2">
                    <input class="input" data-f="price" value="${escapeHtml(p.price ?? 0)}" placeholder="Pre√ßo (ex: 29.90)" />
                    <input class="input" data-f="category" value="${escapeHtml(p.category||"Lanches")}" placeholder="Categoria (Lanches, Pizzas...)" />
                  </div>

                  <div class="grid grid-cols-2 gap-2">
                    <input class="input" data-f="emoji" value="${escapeHtml(p.emoji||"üçΩÔ∏è")}" placeholder="Emoji (ex: üçï)" />
                    <input class="input" data-f="imageUrl" value="${escapeHtml(p.imageUrl||"")}" placeholder="URL da imagem (opcional)" />
                  </div>

                  <label class="flex items-center gap-2 text-sm" style="color:#fde68a;">
                    <input type="checkbox" data-f="isActive" ${p.isActive !== false ? "checked" : ""} />
                    Produto ativo (aparece no card√°pio)
                  </label>
                </div>

                <div class="flex gap-2">
                  <button class="btn btn-primary w-full" data-act="save" data-id="${p.id}">üíæ Salvar</button>
                  <button class="btn btn-red" data-act="del" data-id="${p.id}">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      $("products-list").querySelectorAll(`button[data-act="save"]`).forEach(btn => {
        btn.onclick = () => saveProduct(btn.dataset.id);
      });
      $("products-list").querySelectorAll(`button[data-act="del"]`).forEach(btn => {
        btn.onclick = () => removeProduct(btn.dataset.id);
      });
    }

    async function addProduct(){
      $("products-error").classList.add("hidden");
      try{
        await addDoc(productsCol(), {
          name: "Novo Produto",
          description: "Descri√ß√£o do produto...",
          price: 0,
          category: "Lanches",
          emoji: "üçΩÔ∏è",
          imageUrl: "",
          isActive: true,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      } catch(err){
        $("products-error").textContent = "Erro ao salvar produto. Verifique rules /restaurants/{id}/products.";
        $("products-error").classList.remove("hidden");
      }
    }

    async function saveProduct(id){
      $("products-error").classList.add("hidden");
      const row = document.querySelector(`[data-prod="${id}"]`);
      if(!row) return;

      const name = row.querySelector(`[data-f="name"]`).value.trim();
      const description = row.querySelector(`[data-f="description"]`).value.trim();
      const category = row.querySelector(`[data-f="category"]`).value.trim() || "Lanches";
      const imageUrl = row.querySelector(`[data-f="imageUrl"]`).value.trim();
      const emoji = row.querySelector(`[data-f="emoji"]`).value.trim() || "üçΩÔ∏è";
      const price = safeNumber(row.querySelector(`[data-f="price"]`).value);
      const isActive = row.querySelector(`[data-f="isActive"]`).checked;

      try{
        await updateDoc(doc(db, "restaurants", restaurantId, "products", id), {
          name, description, category, imageUrl, emoji,
          price: Number(price),
          isActive,
          updatedAt: serverTimestamp()
        });
      } catch(err){
        $("products-error").textContent = "Erro ao atualizar produto. Verifique rules.";
        $("products-error").classList.remove("hidden");
      }
    }

    async function removeProduct(id){
      $("products-error").classList.add("hidden");
      if(!confirm("Excluir este produto?")) return;
      try{
        await deleteDoc(doc(db, "restaurants", restaurantId, "products", id));
      } catch(err){
        $("products-error").textContent = "Erro ao excluir produto. Verifique rules.";
        $("products-error").classList.remove("hidden");
      }
    }

    function startProductsRealtime(){
      if(unsubProducts) unsubProducts();
      const qy = query(productsCol(), orderBy("createdAt", "desc"));
      unsubProducts = onSnapshot(qy, (snap) => {
        liveProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderProducts();
      }, () => {
        $("products-error").textContent = "Erro ao carregar produtos. Verifique rules.";
        $("products-error").classList.remove("hidden");
      });
    }

    $("btn-add-product").addEventListener("click", addProduct);
    $("prod-search").addEventListener("input", renderProducts);

    // =======================
    // Orders (Realtime + status + dashboard)
    // =======================
    let unsubOrders = null;
    let liveOrders = [];

    function moneyBR(v){
      const n = Number(v || 0);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function fmtDate(ts){
      try{
        if(!ts) return "";
        const d = ts?.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString("pt-BR");
      }catch{
        return "";
      }
    }

    function statusLabel(s){
      const map = {
        new: "üÜï Novo",
        accepted: "‚úÖ Aceito",
        preparing: "üë®‚Äçüç≥ Preparando",
        ready: "üì¶ Pronto",
        delivered: "üèÅ Entregue",
        canceled: "‚ùå Cancelado"
      };
      return map[s] || s || "‚Äî";
    }

    async function updateOrderStatus(orderId, status){
      $("orders-error").classList.add("hidden");
      try{
        await updateDoc(doc(db, "restaurants", restaurantId, "orders", orderId), {
          status,
          updatedAt: serverTimestamp()
        });
      }catch(e){
        $("orders-error").textContent = "Erro ao atualizar status do pedido. Verifique rules.";
        $("orders-error").classList.remove("hidden");
      }
    }

    function renderDashboard(){
      const orders = liveOrders || [];
      $("dash-orders").textContent = String(orders.length);

      const revenue = orders.reduce((s, o) => s + Number(o.total || 0), 0);
      $("dash-revenue").textContent = moneyBR(revenue);

      // top items
      const map = new Map(); // name -> qty
      for(const o of orders){
        for(const it of (o.items || [])){
          const key = String(it.name || "Item").trim();
          const qty = Number(it.qty || 0);
          map.set(key, (map.get(key) || 0) + qty);
        }
      }
      const top = [...map.entries()].sort((a,b) => b[1]-a[1]).slice(0, 10);
      const box = $("dash-top-items");
      if(!box) return;

      if(top.length === 0){
        box.innerHTML = `<p class="muted">Sem dados ainda.</p>`;
        return;
      }

      box.innerHTML = top.map(([name, qty]) => `
        <div class="flex justify-between rounded-xl bg-neutral-950 border border-neutral-800 px-3 py-2">
          <span class="text-sm" style="color:#fde68a;">${escapeHtml(name)}</span>
          <b style="color:#fde68a;">${qty}</b>
        </div>
      `).join("");
    }

    function renderOrders(){
      const filter = ($("orders-filter")?.value || "all");
      let list = [...liveOrders];

      if(filter !== "all"){
        list = list.filter(o => (o.status || "new") === filter);
      }

      $("orders-count").textContent = `üì¶ ${list.length}`;
      $("orders-empty").classList.toggle("hidden", list.length !== 0);

      $("orders-list").innerHTML = list.map(o => {
        const items = (o.items || [])
          .map(i => `‚Ä¢ ${i.qty}x ${escapeHtml(i.emoji || "üçΩÔ∏è")} ${escapeHtml(i.name)} ‚Äî ${moneyBR((i.price||0)*(i.qty||0))}`)
          .join("<br>");

        const addr = escapeHtml(o.customer?.addressLine || "‚Äî");
        const cust = `${escapeHtml(o.customer?.name || "‚Äî")} ‚Ä¢ ${escapeHtml(o.customer?.phone || "‚Äî")}`;

        const curStatus = (o.status || "new");

        return `
          <div class="p-4 rounded-xl bg-neutral-950 border border-neutral-800" data-order="${o.id}">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
              <div class="space-y-2">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="badge badge-new">${statusLabel(curStatus)}</span>
                  <span class="text-xs muted">${fmtDate(o.createdAt)}</span>
                  <span class="text-xs muted">ID: ${escapeHtml(o.id)}</span>
                </div>

                <div class="text-sm" style="color:#fde68a;"><b>Cliente:</b> ${cust}</div>
                <div class="text-sm muted"><b>Endere√ßo:</b> ${addr}</div>

                <div class="mt-3 text-sm muted">
                  <b>Itens:</b><br>${items || "‚Äî"}
                </div>

                <div class="mt-2 text-lg font-extrabold" style="color:#fde68a;">
                  Total: ${moneyBR(o.total)}
                </div>
              </div>

              <div class="min-w-[220px] space-y-2">
                <select class="input" data-act="status">
                  <option value="new" ${curStatus==="new"?"selected":""}>üÜï Novo</option>
                  <option value="accepted" ${curStatus==="accepted"?"selected":""}>‚úÖ Aceito</option>
                  <option value="preparing" ${curStatus==="preparing"?"selected":""}>üë®‚Äçüç≥ Preparando</option>
                  <option value="ready" ${curStatus==="ready"?"selected":""}>üì¶ Pronto</option>
                  <option value="delivered" ${curStatus==="delivered"?"selected":""}>üèÅ Entregue</option>
                  <option value="canceled" ${curStatus==="canceled"?"selected":""}>‚ùå Cancelado</option>
                </select>

                <button class="btn btn-primary w-full" data-act="save-status" data-id="${o.id}">üíæ Salvar status</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      $("orders-list").querySelectorAll(`button[data-act="save-status"]`).forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const row = document.querySelector(`[data-order="${id}"]`);
          const sel = row?.querySelector(`[data-act="status"]`);
          const status = sel?.value || "new";
          await updateOrderStatus(id, status);
        };
      });

      renderDashboard();
    }

    function startOrdersRealtime(){
      if(unsubOrders) unsubOrders();
      const qy = query(ordersCol(), orderBy("createdAt", "desc"), limit(200));
      unsubOrders = onSnapshot(qy, (snap) => {
        liveOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderOrders();
      }, () => {
        $("orders-error").textContent = "Erro ao carregar pedidos. Verifique rules.";
        $("orders-error").classList.remove("hidden");
      });
    }

    $("orders-filter")?.addEventListener("change", renderOrders);

    // =======================
    // Auth state
    // =======================
    $("btn-logout").addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if(user){
        restaurantId = await resolveRestaurantId(user);

        if(!restaurantId){
          alert("‚ö†Ô∏è N√£o encontrei o restaurante desse usu√°rio.\nCrie a conta novamente ou verifique /users/{uid}.");
          await signOut(auth);
          return;
        }

        localStorage.setItem("restaurantId", restaurantId);

        $("login-overlay").classList.add("hidden");
        $("app").classList.remove("hidden");

        updateShareLinkUI();

        await loadRestaurantSettings();
        await loadCategoryTitles();

        startProductsRealtime();
        startOrdersRealtime();

        setTab("products");
      } else {
        $("app").classList.add("hidden");
        $("login-overlay").classList.remove("hidden");

        if(unsubProducts) unsubProducts();
        unsubProducts = null;
        liveProducts = [];
        $("products-list").innerHTML = "";
        $("products-count").textContent = "üçî 0";
        $("products-empty").classList.add("hidden");

        if(unsubOrders) unsubOrders();
        unsubOrders = null;
        liveOrders = [];
        $("orders-list").innerHTML = "";
        $("orders-count").textContent = "üì¶ 0";
        $("orders-empty").classList.add("hidden");
        $("dash-orders").textContent = "0";
        $("dash-revenue").textContent = "R$ 0,00";
        $("dash-top-items").innerHTML = "";
      }
    });
  </script>
</body>
</html>
